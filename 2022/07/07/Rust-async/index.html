<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="记录学习Rust异步编程的笔记。"><title>Rust异步编程</title>
<link rel=canonical href=https://wenjin1997.github.io/2022/07/07/Rust-async/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Rust异步编程"><meta property='og:description' content="记录学习Rust异步编程的笔记。"><meta property='og:url' content='https://wenjin1997.github.io/2022/07/07/Rust-async/'><meta property='og:site_name' content="Jade's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Rust'><meta property='article:tag' content='异步'><meta property='article:published_time' content='2022-07-07T00:00:00+00:00'><meta property='article:modified_time' content='2022-07-07T00:00:00+00:00'><meta name=twitter:title content="Rust异步编程"><meta name=twitter:description content="记录学习Rust异步编程的笔记。"><link rel="shortcut icon" href=/img/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/ghost_hu15175528053352950562.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Jade's Blog</a></h1><h2 class=site-description>Keep Learning and Thinking!</h2></div></header><ol class=menu-social><li><a href=https://github.com/wenjin1997 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/ChinnellHeish target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span></span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title"></h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#异步io模型>异步IO模型</a><ol><li><a href=#基本概念>基本概念</a></li><li><a href=#io模型>I/O模型</a></li><li><a href=#同步阻塞io>同步阻塞I/O</a></li><li><a href=#io多路复用>I/O多路复用</a></li><li><a href=#补充资料>补充资料</a></li></ol></li><li><a href=#epoll>epoll</a><ol><li><a href=#补充资料-1>补充资料</a></li></ol></li><li><a href=#io_uring-异步-io-模型>io_uring 异步 I/O 模型</a></li><li><a href=#事件驱动编程模型>事件驱动编程模型</a><ol><li><a href=#补充资料-2>补充资料</a></li></ol></li><li><a href=#epoll代码实践>epoll代码实践</a></li><li><a href=#reactor代码实践>Reactor代码实践</a></li><li><a href=#minimio代码实践>MiniMio代码实践</a></li><li><a href=#mio代码实践>Mio代码实践</a></li><li><a href=#异步编程模型概要>异步编程模型概要</a></li><li><a href=#future和futures-rs介绍>Future和Futures-rs介绍</a></li><li><a href=#编写异步echo服务>编写异步echo服务</a></li><li><a href=#深入理解异步task模型>深入理解异步Task模型</a></li><li><a href=#async-await语法背后>async-await语法背后</a><ol><li><a href=#历史>历史</a></li><li><a href=#asyncawait-语法介绍>async/await 语法介绍</a></li></ol></li><li><a href=#生成器>生成器</a></li><li><a href=#no-std异步生态介绍>no-std异步生态介绍</a></li><li><a href=#一个异步缓存代码实现>一个异步缓存代码实现</a></li><li><a href=#异步运行时生态>异步运行时生态</a></li><li><a href=#smol运行时>smol运行时</a><ol><li><a href=#smol文档httpsdocsrssmollatestsmol><a href=https://docs.rs/smol/latest/smol/>smol文档</a></a></li><li><a href=#smol源码>smol源码</a></li><li><a href=#聊天框例子>聊天框例子</a><ol><li><a href=#chat-server>chat-server</a></li><li><a href=#chat-client>chat-client</a></li></ol></li><li><a href=#futures_lite>futures_lite</a></li><li><a href=#async_io>async_io</a></li><li><a href=#async_task>async_task</a></li><li><a href=#async_executor>async_executor</a></li><li><a href=#blocking>blocking</a></li></ol></li><li><a href=#async-std>async-std</a></li><li><a href=#tokio>tokio</a><ol><li><a href=#mini-redis>mini-redis</a></li><li><a href=#流处理>流处理</a></li><li><a href=#扩展资料>扩展资料</a></li></ol></li><li><a href=#参考资料>参考资料</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/tech/>Tech</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/2022/07/07/Rust-async/>Rust异步编程</a></h2><h3 class=article-subtitle>记录学习Rust异步编程的笔记。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jul 07, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading></time></div></footer></div></header><section class=article-content><p>本章至下而上的方式来带领大家理解异步编程:</p><ol><li>异步 I/O 模型</li><li>异步编程模型：<ul><li>事件驱动模型</li><li>Futures</li><li>生成器 与 Pin</li><li>async/await</li><li>异步运行时介绍：async-std、tokio、bastion、smol</li></ul></li></ol><h2 id=异步io模型>异步IO模型</h2><h3 id=基本概念>基本概念</h3><ul><li>同步和异步，关注的是消息通信机制。（调用者视角）结合烧开水的例子。<ul><li>同步，发出一个调用，在没有得到结果之前不返回。水没烧好不离开。</li><li>异步，发出一个调用，在没有得到结果之前返回。水没烧好时，可以先去干别的。</li></ul></li><li>阻塞和非阻塞，关注的是程序等待调用结果的状态。（被调用者视角）<ul><li>阻塞，在调用结果返回之前，线程被挂起。</li><li>非阻塞，在调用结果返回之前，线程不会被挂起。</li></ul></li></ul><p>阻塞，与系统调用有关。</p><h3 id=io模型>I/O模型</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>                                 +-+ 阻 塞 I/O (BIO)
</span></span><span class=line><span class=cl>                                 |
</span></span><span class=line><span class=cl>                                 +-+ 非 阻 塞 I/O (NIO)
</span></span><span class=line><span class=cl>                                 |
</span></span><span class=line><span class=cl>              +----+ 同 步 I/O +--+
</span></span><span class=line><span class=cl>              |                  |
</span></span><span class=line><span class=cl>              |                  +-+ I/O 多 路 复 用
</span></span><span class=line><span class=cl>              |                  |
</span></span><span class=line><span class=cl>              |                  +-+ 信 号 驱 动 I/O
</span></span><span class=line><span class=cl>I/O 模 型  +---+
</span></span><span class=line><span class=cl>              |
</span></span><span class=line><span class=cl>              |
</span></span><span class=line><span class=cl>              |                  +-+ Linux (AIO)
</span></span><span class=line><span class=cl>              |                  |         (io_uring)
</span></span><span class=line><span class=cl>              +----+ 异 步 I/O +--+
</span></span><span class=line><span class=cl>                                 |
</span></span><span class=line><span class=cl>                                 +-+ windows (IOCP)
</span></span></code></pre></td></tr></table></div></div><h3 id=同步阻塞io>同步阻塞I/O</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Application               kernel
</span></span><span class=line><span class=cl>+---------+            +-----------+  +---+
</span></span><span class=line><span class=cl>|         |   syscall  | no        |      |
</span></span><span class=line><span class=cl>|   Read  | +--------&gt; | datagram  |      |
</span></span><span class=line><span class=cl>| recvfrom|            | ready     |      |
</span></span><span class=line><span class=cl>|         |            |    +      |      +-+ wait for
</span></span><span class=line><span class=cl>|         |            |    |      |      +-+ data
</span></span><span class=line><span class=cl>|         |            |    v      |      |
</span></span><span class=line><span class=cl>|         |            | datagram  |      |
</span></span><span class=line><span class=cl>|         |            | ready     |  +---+
</span></span><span class=line><span class=cl>|         |            |           |
</span></span><span class=line><span class=cl>|         |            | copy      |  +---+
</span></span><span class=line><span class=cl>|         |            | datagram  |      |
</span></span><span class=line><span class=cl>|process  |            |    +      |      +-+ copy data
</span></span><span class=line><span class=cl>|datagram |   return   |    |      |      +-+ from kernel to user
</span></span><span class=line><span class=cl>|         | &lt;--------+ |    v      |      |
</span></span><span class=line><span class=cl>|         |            |  copy     |  +---+
</span></span><span class=line><span class=cl>|         |            |  complete |
</span></span><span class=line><span class=cl>+---------+            +-----------+
</span></span></code></pre></td></tr></table></div></div><p>输入操作两个阶段：</p><ol><li>进程等待内核把数据准备好；这个阶段可以阻塞也可非阻塞，设置socket属性。<ul><li>阻塞： recvfrom 阻塞线程直到返回数据就绪的结果。</li><li>非阻塞：立即返回一个错误，轮询直到数据就绪。</li></ul></li><li>从内核缓冲区向进程缓冲区复制数据。（一直阻塞）</li></ol><p>异步I/O，recvfrom总是立即返回，两个阶段都由内核完成。</p><h3 id=io多路复用>I/O多路复用</h3><p>IO多路复用是一种同步IO模型，实现一个线程可以监视多个文件句柄。</p><p>支持I/O多路复用的系统调用有 select/pselect/poll/epoll，本质都是 同步 I/O，因为数据拷贝都是阻塞的。 通过 select/epoll 来判断数据报是否准备好，即判断可读可写状态。</p><h3 id=补充资料>补充资料</h3><p>I/O模型和I/O调用是不是分不清楚，参考<a class=link href=https://cloud.tencent.com/developer/article/1684951 target=_blank rel=noopener>理解一下5种IO模型、阻塞IO和非阻塞IO、同步IO和异步IO</a>。</p><p>先理解什么是IO：</p><p><img src=/img/2022-07-07-Rust-async/image-20220815091311443.png loading=lazy alt=image-20220815091311443></p><p>要输入输出数据分为两个阶段：用户进程空间&lt;&ndash;>内核空间、内核空间&lt;&ndash;>设备空间（磁盘、网络等）。</p><ol><li><p>阻塞IO模型</p><p><img src=/img/2022-07-07-Rust-async/image-20220815091553220.png loading=lazy alt=image-20220815091553220></p><p>进程发起IO系统调用后，进程被阻塞，转到内核空间处理，整个IO处理完毕后返回进程。操作成功则进程获取到数据。</p></li><li><p>非阻塞IO模型</p><p><img src=/img/2022-07-07-Rust-async/image-20220815091819969.png loading=lazy alt=image-20220815091819969></p><p>进程发起IO系统调用后，如果内核缓冲区没有数据，需要到IO设备中读取，进程返回一个错误而不会被阻塞；进程发起IO系统调用后，如果内核缓冲区有数据，内核就会把数据返回进程。</p></li><li><p>IO复用模型</p><p><img src=/img/2022-07-07-Rust-async/image-20220815092054045.png loading=lazy alt=image-20220815092054045></p><p>多个进程的IO可以注册到一个复用器（select）上，然后用一个进程调用该select，select会监听所有注册进来的IO；</p><p>如果select没有监听的IO在内核缓冲区都没有可读数据，select调用进程会被阻塞；而当任一IO在内核缓冲区中有可用数据时，select调用就会返回；</p><p>而后select调用进程可以自己或通知另外的进程（注册进程）来再次发起读取IO，读取内核中准备好的数据。</p><p>select、poll、epoll</p><ul><li>Linux中IO复用的实现方式主要有select、poll和epoll。</li><li>Select: 注册IO、阻塞扫描，监听的IO最大连接数不能多于FD_SIZE。</li><li>Poll: 原理和Select相似，没有数量限制，但IO数量大扫描线性性能下降。</li><li>Epoll：事件驱动不阻塞，mmap实现内核与用户空间的消息传递，数量很大，Linux2.6后内核支持。</li></ul></li><li><p>信号驱动IO模型</p><p><img src=/img/2022-07-07-Rust-async/image-20220815093027374.png loading=lazy alt=image-20220815093027374></p><p>当进程发起一个IO操作，会向内核注册一个信号处理函数，然后进程返回不阻塞；当内核数据就绪时会发生一个信号给进程，进程便在信号处理函数中调用IO读取数据。</p><p>特点：回调机制，实现、开发应用难度大。</p></li><li><p>异步IO模型</p><p><img src=/img/2022-07-07-Rust-async/image-20220815093324750.png loading=lazy alt=image-20220815093324750></p><p>当进程发起一个IO操作，进程返回（不阻塞），但也不能返回结果；内核把整个IO处理完后，会通知进程结果。如果IO操作成功则进程直接获取到数据。</p></li></ol><p>一图总结：</p><p><img src=/img/2022-07-07-Rust-async/rust_async_I:O_model.png loading=lazy alt=img></p><h2 id=epoll>epoll</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>                        +--------------------------------+     +-------------------------+
</span></span><span class=line><span class=cl>                        | epoll_ctl                      |     | epoll_wait              |
</span></span><span class=line><span class=cl>                        |                                |     |                         |
</span></span><span class=line><span class=cl>                        |                                |     |         +----+          |
</span></span><span class=line><span class=cl>                        |                 +---+          |     |         |    |          |
</span></span><span class=line><span class=cl>                        |                 |   |          |     |         |    |          |
</span></span><span class=line><span class=cl>                        |               +-+---+--+       |     |         +--+-+          |
</span></span><span class=line><span class=cl>                        |               |        |       |     |            |            |
</span></span><span class=line><span class=cl>                        |            +--++     +-++      |     |            |            |
</span></span><span class=line><span class=cl>epoll_create  +----&gt;    |            |   |     |  |      |     |         +--+-+          |
</span></span><span class=line><span class=cl>                        |            +-+-+     +--+      +----&gt;+         |    |          |
</span></span><span class=line><span class=cl>                        |              |                 |event|         |    |          |
</span></span><span class=line><span class=cl>                        |         +----+--+              |     |         +--+-+          |
</span></span><span class=line><span class=cl>                        |         |       |              |     |            |            |
</span></span><span class=line><span class=cl>                        |         ++      |              |     |            |            |
</span></span><span class=line><span class=cl>                        |        +--+   +-+-+            |     |         +--+-+          |
</span></span><span class=line><span class=cl>                        |        |  |   |   |            |     |         |    |          |
</span></span><span class=line><span class=cl>                        |        +--+   +---+            |     |         |    |          |
</span></span><span class=line><span class=cl>                        |                                |     |         +----+          |
</span></span><span class=line><span class=cl>                        |                    红 黑 树     |     |                 链 表    |
</span></span><span class=line><span class=cl>                        +--------------------------------+     +-------------------------+
</span></span></code></pre></td></tr></table></div></div><ul><li>epoll_create(int size) : 内核产生一个epoll实例数据结构，并返回一个epfd</li><li>epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)：将被监听的描述符添加到红黑树或从红黑树中删除或者对监听事件进行修改。</li><li>epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout): 阻塞等待注册的事件发生，返回事件的数目，并将触发的事件写入events数组中</li></ul><p>epoll 两种触发机制：</p><ul><li>水平触发机制（LT)。缓冲区只要有数据就触发读写。epoll 默认工作方式。select/poll只支持该方式。</li><li>边缘触发机制（ET)。缓冲区空或满的状态才触发读写。nginx 使用该方式，避免频繁读写。</li></ul><p>惊群问题：</p><p>当多个进程/线程调用epoll_wait时会阻塞等待，当内核触发可读写事件，所有进程/线程都会进行响应，但是实际上只有一个进程/线程真实处理这些事件。 Liux 4.5 通过引入 EPOLLEXCLUSIVE 标识来保证一个事件发生时候只有一个线程会被唤醒，以避免多侦听下的惊群问题。</p><h3 id=补充资料-1>补充资料</h3><p><a class=link href=https://www.cnblogs.com/lojunren/p/3856290.html target=_blank rel=noopener>Linux下的I/O复用与epoll详解</a></p><p>select、poll、epoll</p><ul><li>Linux中IO复用的实现方式主要有select、poll和epoll：</li><li>Select：注册IO、阻塞扫描，监听的IO最大连接数不能多于FD_SIZE；</li><li>Poll：原理和Select相似，没有数量限制，但IO数量大扫描线性性能下降；</li><li>Epoll ：事件驱动不阻塞，mmap实现内核与用户空间的消息传递，数量很大，Linux2.6后内核支持。</li></ul><p>select的缺陷：</p><ul><li>select预估错误了一件事，当数十万并发连接存在时，可能每一毫秒只有数百个活跃的连接，同时其余数十万连接在这一毫秒是非活跃的。</li><li>在Linux内核中，select所用到的FD_SET是有限的，即内核中有个参数__FD_SETSIZE定义了每个FD_SET的句柄个数。</li><li>内核中实现 select是用<strong>轮询</strong>方法，即每次检测都会遍历所有FD_SET中的句柄，显然，select函数执行时间与FD_SET中的句柄个数有一个比例关系，即 select要检测的句柄数越多就会越费时。</li></ul><p>相比于select机制，poll只是取消了最大监控文件描述符数限制，并没有从根本上解决select存在的问题。</p><p>epoll精巧的使用了3个方法来实现select方法要做的事：</p><ol><li>新建epoll描述符==epoll_create()</li><li>epoll_ctl(epoll描述符，添加或者删除所有待监控的连接)</li><li>返回的活跃连接 ==epoll_wait（ epoll描述符 ）</li></ol><p>与select相比，epoll分清了频繁调用和不频繁调用的操作。例如，epoll_ctl是不太频繁调用的，而epoll_wait是非常频繁调用的。这时，epoll_wait却几乎没有入参，这比select的效率高出一大截，而且，它也不会随着并发连接的增加使得入参越发多起来，导致内核执行效率下降。</p><p>要深刻理解epoll，首先得了解epoll的三大关键要素：<strong>mmap、红黑树、链表</strong>。</p><p>epoll是通过内核与用户空间mmap同一块内存实现的。mmap将用户空间的一块地址和内核空间的一块地址同时映射到相同的一块物理内存地址（不管是用户空间还是内核空间都是虚拟地址，最终要通过地址映射映射到物理地址），使得这块物理内存对内核和对用户均可见，减少用户态和内核态之间的数据交换。内核可以直接看到epoll监听的句柄，效率高。</p><p><a class=link href=https://zh.m.wikipedia.org/zh/%E7%BA%A2%E9%BB%91%E6%A0%91 target=_blank rel=noopener>红黑树</a>将存储epoll所监听的套接字。上面mmap出来的内存如何保存epoll所监听的套接字，必然也得有一套数据结构，epoll在实现上采用红黑树去存储所有套接字，当添加或者删除一个套接字时（epoll_ctl），都在红黑树上去处理，红黑树本身插入和删除性能比较好，时间复杂度O(logN)。</p><p>通过epoll_ctl函数添加进来的事件都会被放在红黑树的某个节点内，所以，重复添加是没有用的。当把事件添加进来的时候时候会完成关键的一步，那就是该事件都会与相应的设备（网卡）驱动程序建立回调关系，当相应的事件发生后，就会调用这个回调函数，该回调函数在内核中被称为：ep_poll_callback,<strong>这个回调函数其实就所把这个事件添加到rdllist这个双向链表中</strong>。一旦有事件发生，epoll就会将该事件添加到双向链表中。那么当我们调用epoll_wait时，epoll_wait只需要检查rdlist双向链表中是否有存在注册的事件，效率非常可观。这里也需要将发生了的事件复制到用户态内存中即可。</p><p><img src=/img/2022-07-07-Rust-async/rust_async_epoll.jpeg loading=lazy alt=img></p><p>epoll_wait的工作流程：</p><ol><li>epoll_wait调用ep_poll，当rdlist为空（无就绪fd）时挂起当前进程，直到rdlist不空时进程才被唤醒。</li><li>文件fd状态改变（buffer由不可读变为可读或由不可写变为可写），导致相应fd上的回调函数ep_poll_callback()被调用。</li><li>ep_poll_callback将相应fd对应epitem加入rdlist，导致rdlist不空，进程被唤醒，epoll_wait得以继续执行。</li><li>ep_events_transfer函数将rdlist中的epitem拷贝到txlist中，并将rdlist清空。</li><li>ep_send_events函数（很关键），它扫描txlist中的每个epitem，调用其关联fd对用的poll方法。此时对poll的调用仅仅是取得fd上较新的events（防止之前events被更新），之后将取得的events和相应的fd发送到用户空间（封装在struct epoll_event，从epoll_wait返回）。</li></ol><p>select、poll和epoll三种I/O复用模式的比较：</p><div class=table-wrapper><table><thead><tr><th>系统调用</th><th>select</th><th>poll</th><th>epoll</th></tr></thead><tbody><tr><td>事件集合</td><td>用户通过3个参数分别传入感兴趣的可读，可写及异常等事件内核通过对这些参数的在线修改来反馈其中的就绪事件这使得用户每次调用select都要重置这3个参数</td><td>统一处理所有事件类型，因此只需要一个事件集参数。用户通过pollfd.events传入感兴趣的事件，内核通过修改pollfd.revents反馈其中就绪的事件</td><td>内核通过一个事件表直接管理用户感兴趣的所有事件。因此每次调用epoll_wait时，无需反复传入用户感兴趣的事件。epoll_wait系统调用的参数events仅用来反馈就绪的事件</td></tr><tr><td>应用程序索引就绪文件描述符的时间复杂度</td><td>O(n)</td><td>O(n)</td><td>O(1)</td></tr><tr><td>最大支持文件描述符数</td><td>一般有最大值限制</td><td>65535</td><td>65535</td></tr><tr><td>工作模式</td><td>LT</td><td>LT</td><td>支持ET高效模式</td></tr><tr><td>内核实现和工作效率</td><td>采用轮询方式检测就绪事件，时间复杂度：O(n)</td><td>采用轮询方式检测就绪事件，时间复杂度：O(n)</td><td>采用回调方式检测就绪事件，时间复杂度：O(1)</td></tr></tbody></table></div><h2 id=io_uring-异步-io-模型>io_uring 异步 I/O 模型</h2><p>Linux AIO 实现的并不理想，所以引入了新的异步I/O接口 io_uring。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>+----+ Head  +---------+               +----------+ Head
</span></span><span class=line><span class=cl>|            |         |               |          |
</span></span><span class=line><span class=cl>|            |         |               |          |
</span></span><span class=line><span class=cl>|            +---------+               +----------+
</span></span><span class=line><span class=cl>|            |         |               |          |
</span></span><span class=line><span class=cl>|            |         |               |          |
</span></span><span class=line><span class=cl>|            +---------+               +----------+
</span></span><span class=line><span class=cl>|            |         |               |          |
</span></span><span class=line><span class=cl>|            |         |               |          |
</span></span><span class=line><span class=cl>|            +---------+               +----------+
</span></span><span class=line><span class=cl>|            |         |               |          |
</span></span><span class=line><span class=cl>|      Tail  +---------+               +----------+ Tail &lt;--+
</span></span><span class=line><span class=cl>|        +--------------------------------------------+     |
</span></span><span class=line><span class=cl>|        | Kernel                                     |     |
</span></span><span class=line><span class=cl>|        |                                            |     |
</span></span><span class=line><span class=cl>|        |        +-------+              +-------+    |     |
</span></span><span class=line><span class=cl>|        |        |       |              |       |    |     |
</span></span><span class=line><span class=cl>+---------------&gt; | SQ    |              |  CQ   | +--------+
</span></span><span class=line><span class=cl>         |        |       |              |       |    |
</span></span><span class=line><span class=cl>         |        +-------+              +-------+    |
</span></span><span class=line><span class=cl>         |                                            |
</span></span><span class=line><span class=cl>         +--------------------------------------------+
</span></span></code></pre></td></tr></table></div></div><p>io_uring接口通过两个主要数据结构工作：</p><ul><li>提交队列条目（sqe）</li><li>完成队列条目（cqe）</li></ul><p>这些结构的实例位于内核和应用程序之间的<strong>共享内存</strong>单生产者单消费者环形缓冲区中。</p><p>参考：</p><ul><li><a class=link href=https://thenewstack.io/how-io_uring-and-ebpf-will-revolutionize-programming-in-linux/ target=_blank rel=noopener>How io_uring and eBPF Will Revolutionize Programming in Linux</a></li><li><a class=link href=https://cor3ntin.github.io/posts/iouring/#io_uring target=_blank rel=noopener>A Universal I/O Abstraction for C++</a></li></ul><p><img src=/img/2022-07-07-Rust-async/image-20220815104458456.png loading=lazy alt=image-20220815104458456></p><h2 id=事件驱动编程模型>事件驱动编程模型</h2><p>因为处理 I/O 复用的编程模型相当复杂，为了简化编程，引入了下面两种模型。</p><ul><li>Reactor（反应器） 模式，对应同步I/O，被动的事件分离和分发模型。服务等待请求事件的到来，再通过不受间断的同步处理事件，从而做出反应。</li><li>Preactor（主动器） 模式，对应异步I/O，主动的事件分离和分发模型。这种设计允许多个任务并发的执行，从而提高吞吐量；并可执行耗时长的任务（各个任务间互不影响）。</li></ul><p>Reactor Model:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>                                                     +----------------+
</span></span><span class=line><span class=cl>req                                        Dispatch  |                |
</span></span><span class=line><span class=cl>+------+                                  +--------&gt; | req handler    |
</span></span><span class=line><span class=cl>|      |                                  |          +----------------+
</span></span><span class=line><span class=cl>|      | +----+                           |
</span></span><span class=line><span class=cl>+------+      | event    +------------+   |
</span></span><span class=line><span class=cl>              |          |            |   |
</span></span><span class=line><span class=cl>              +--------&gt; |  Service   |   |Dispatch  +----------------+
</span></span><span class=line><span class=cl>                         |  Handler   +------------&gt; |                |
</span></span><span class=line><span class=cl>req          +---------&gt; |            |   |          | req handler    |
</span></span><span class=line><span class=cl>+------+     |           +------------+   |          +----------------+
</span></span><span class=line><span class=cl>|      |     | event                      |
</span></span><span class=line><span class=cl>|      +----+                             |
</span></span><span class=line><span class=cl>+------+                                  | Dispatch +----------------+
</span></span><span class=line><span class=cl>                                          +---------&gt;+                |
</span></span><span class=line><span class=cl>                                                     | req handler    |
</span></span><span class=line><span class=cl>                                                     +----------------+
</span></span></code></pre></td></tr></table></div></div><p>三种实现方式：</p><ul><li>单线程模式。 accept()、read()、write()以及connect()操作 都在同一线程。</li><li>工作者线程池模式。非 I/O 操作交给线程池处理</li><li>多线程模式。主Reactor (master) ，负责网络监听 ， 子Reactor(worker) 读写网络数据。</li></ul><p>读写操作流程：</p><ol><li>应用注册读写就绪事件和相关联的事件处理器</li><li>事件分离器等待事件发生</li><li>当发生读写就绪事件，事件分离器调用已注册的事件处理器</li><li>事件处理器执行读写操作</li></ol><p>参与者：</p><ol><li>描述符（handle）：操作系统提供的资源，识别 socket等。</li><li>同步事件多路分离器。开启事件循环，等待事件的发生。封装了 多路复用函数 select/poll/epoll等。</li><li>事件处理器。提供回调函数，用于描述与应用程序相关的某个事件的操作。</li><li>具体的事件处理器。事件处理器接口的具体实现。使用描述符来识别事件和程序提供的服务。</li><li>Reactor 管理器。事件处理器的调度核心。分离每个事件，调度事件管理器，调用具体的函数处理某个事件。</li></ol><h3 id=补充资料-2>补充资料</h3><p><a class=link href=https://segmentfault.com/a/1190000022048085 target=_blank rel=noopener>事件驱动及其设计模式</a></p><p>从事件角度说，事件驱动程序的基本结构是由一个事件收集器、一个事件发送器和一个事件处理器组成。</p><p><strong>事件循环器的实现</strong></p><p>事件循环器不断接受来自客户端（Client）的请求，事件循环器把请求转交给注册了某类事件的工作线程（Worker）处理。</p><p><img src=/img/2022-07-07-Rust-async/image-20220815105703262.png loading=lazy alt=image-20220815105703262></p><p>根据实现的方式不同，在网络编程中基于事件驱动主要有两种设计模式：Reactor和Proactor。</p><p><strong>Reactor模式框架</strong></p><p>使用Reactor模型，必备的几个组件：事件源、Reactor框架、事件多路复用机制和事件处理程序，先来看看Reactor模型的整体框架，接下来再对每个组件做逐一说明。</p><p>1）事件源：Linux上是文件描述符，Windows上就是Socket或者Handle了，这里统一称为“句柄集”；程序在指定的句柄上注册关心的事件，比如I/O事件。</p><p>2）事件多路复用机制：由操作系统提供的I/O多路复用机制，比如select和epoll。程序首先将其关心的句柄（事件源）及其事件注册到多路复用机制上。当有事件到达时，事件多路复用机制会发出通知“在已经注册的句柄集中，一个或多个句柄的事件已经就绪”。程序收到通知后，就可以在非阻塞的情况下对事件进行处理了。</p><p>3） Reactor。是事件管理的接口，内部使用事件多路复用机制注册、注销事件；并运行事件循环，当有事件进入“就绪”状态时，调用注册事件的回调函数处理事件。</p><p>4）事件处理程序。事件处理程序提供了一组接口，每个接口对应了一种类型的事件，供Reactor在相应的事件发生时调用，执行相应的事件处理。通常它会绑定一个有效的句柄。</p><p>使用Reactor模式后，事件控制流是什么样子呢？可以参见下面的序列图。</p><p><img src=/img/2022-07-07-Rust-async/rust_async_reactor.webp loading=lazy alt=img></p><p>我们分别以读操作和写操作为例来看看Reactor中的具体步骤：</p><ol><li><p>应用程序注册读就绪事件和相关联的事件处理器；</p></li><li><p>事件分离器等待事件的发生；</p></li><li><p>当发生读就绪事件的时候，事件分离器调用第一步注册的事件处理器；</p></li><li><p>事件处理器首先执行实际的读取操作，然后根据读取到的内容进行进一步的处理。</p></li></ol><p>写入操作类似于读取操作，只不过第一步注册的是写就绪事件。</p><p><strong>Proactor</strong></p><p>我们来看看Proactor模式中读取操作和写入操作的过程：</p><ol><li><p>应用程序初始化一个异步读取操作，然后注册相应的事件处理器，此时事件处理器不关注读取就绪事件，而是关注读取完成事件，这是区别于Reactor的关键。</p></li><li><p>事件分离器等待读取操作完成事件。</p></li><li><p>在事件分离器等待读取操作完成的时候，操作系统调用内核线程完成读取操作（异步I/O都是操作系统负责将数据读写到应用传递进来的缓冲区供应用程序操作），并将读取的内容放入用户传递过来的缓存区中。这也是区别于Reactor的一点。</p></li><li><p>事件分离器捕获到读取完成事件后，激活应用程序注册的事件处理器，事件处理器直接从缓存区读取数据，而不需要进行实际的读取操作。</p></li></ol><p>Proactor中写入操作和读取操作，只不过感兴趣的事件是写入完成事件。</p><p>从上面可以看出，Reactor和Proactor模式的主要区别就是真正的读取和写入操作是由谁来完成的，Reactor中需要应用程序自己读取或者写入数据，而Proactor模式中，应用程序不需要进行实际的读写过程，它只需要从缓存区读取或者写入即可，操作系统会读取缓存区或者写入缓存区到真正的I/O设备。</p><h2 id=epoll代码实践>epoll代码实践</h2><p>参见<a class=link href=https://github.com/zupzup/rust-epoll-example/blob/main/src/main.rs target=_blank rel=noopener>rust-epoll-example</a>。</p><h2 id=reactor代码实践>Reactor代码实践</h2><p>参见<a class=link href=https://github.com/zupzup/rust-reactor-executor-example target=_blank rel=noopener>rust-reactore-executor-example</a>。</p><h2 id=minimio代码实践>MiniMio代码实践</h2><p>epoll只支持在Linux系统下使用，而<a class=link href=https://github.com/cfsamson/examples-minimio target=_blank rel=noopener>minimio</a>实现了跨平台。</p><p>会将各个平台的命令拿出来。比如Selector做了抽象，每个平台实际上不同。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[cfg(target_os = </span><span class=s>&#34;windows&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>windows</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[cfg(target_os = </span><span class=s>&#34;windows&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=n>windows</span>::<span class=p>{</span><span class=n>Event</span><span class=p>,</span><span class=w> </span><span class=n>Registrator</span><span class=p>,</span><span class=w> </span><span class=n>Selector</span><span class=p>,</span><span class=w> </span><span class=n>TcpStream</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[cfg(target_os = </span><span class=s>&#34;macos&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>macos</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[cfg(target_os = </span><span class=s>&#34;macos&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=n>macos</span>::<span class=p>{</span><span class=n>Event</span><span class=p>,</span><span class=w> </span><span class=n>Registrator</span><span class=p>,</span><span class=w> </span><span class=n>Selector</span><span class=p>,</span><span class=w> </span><span class=n>TcpStream</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[cfg(target_os = </span><span class=s>&#34;linux&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>linux</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[cfg(target_os = </span><span class=s>&#34;linux&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=n>linux</span>::<span class=p>{</span><span class=n>Event</span><span class=p>,</span><span class=w> </span><span class=n>Registrator</span><span class=p>,</span><span class=w> </span><span class=n>Selector</span><span class=p>,</span><span class=w> </span><span class=n>TcpStream</span><span class=p>};</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在lib.rs中抽象出跨平台的结构Poll。代表事件队列。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Poll</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span>: <span class=nc>Registry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>is_poll_dead</span>: <span class=nc>Arc</span><span class=o>&lt;</span><span class=n>AtomicBool</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Poll有一个轮询方法poll。在实际调用时已经实现了跨平台。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>poll</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>events</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Events</span><span class=p>,</span><span class=w> </span><span class=n>timeout_ms</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=kt>i32</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=kt>usize</span><span class=o>&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=mio代码实践>Mio代码实践</h2><p>生产环境中的多路复用跨平台代码<a class=link href=https://github.com/tokio-rs/mio target=_blank rel=noopener>mio</a>。</p><p>其中抽象出了<a class=link href=https://docs.rs/mio/0.8.4/mio/struct.Poll.html target=_blank rel=noopener>Poll</a>结构体。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Poll</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span>: <span class=nc>Registry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里用到了设计模式——外观模式，外观模式相关知识见<a class=link href=https://www.runoob.com/design-pattern/facade-pattern.html target=_blank rel=noopener>这里</a>。</p><p>外观模式（Facade Pattern）隐藏系统的复杂性，并向客户端提供了一个客户端可以访问系统的接口。这种类型的设计模式属于结构型模式，它向现有的系统添加一个接口，来隐藏系统的复杂性。</p><p>这种模式涉及到一个单一的类，该类提供了客户端请求的简化方法和对现有系统类方法的委托调用。</p><h2 id=异步编程模型概要>异步编程模型概要</h2><p>让我们先从建立异步编程模型的整体概念框架开始，先不深入细节。</p><p><strong>Rust 提供的异步并发相比于其他语言有什么特点？</strong></p><ol><li>Rust 语言只是提供一个零成本的异步编程抽象，而不内置运行时。</li><li>基于 Generator 实现的 Future，在 Future 基础上 提供 async/await 语法糖。本质是一个状态机。</li></ol><p>查看 README 和其他编程语言比较的图示。</p><p><img src=/img/2022-07-07-Rust-async/node_async.png loading=lazy alt=node></p><p><img src=/img/2022-07-07-Rust-async/go_async.png loading=lazy alt=go></p><p><img src=/img/2022-07-07-Rust-async/rust_async_01.png loading=lazy alt=rust></p><p><img src=/img/2022-07-07-Rust-async/async_01.png loading=lazy alt=rustasync></p><p><strong>为什么需要异步？</strong></p><ol><li>对极致性能的追求。</li><li>对编程体验的追求。</li></ol><p><strong>异步编程模型发展阶段：</strong></p><ol><li>Callback</li><li>Promise/Future</li><li>async/await</li></ol><p>可在项目 README 查看回调地狱示例图。</p><p><img src=/img/2022-07-07-Rust-async/callback-hell.gif loading=lazy alt=callback_hell></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>A
</span></span><span class=line><span class=cl>+------+
</span></span><span class=line><span class=cl>|      |
</span></span><span class=line><span class=cl>|      |
</span></span><span class=line><span class=cl>|      +-------------------+
</span></span><span class=line><span class=cl>|      |                   |
</span></span><span class=line><span class=cl>|      |                   |
</span></span><span class=line><span class=cl>|      |                  Bv
</span></span><span class=line><span class=cl>+------+                +-----+
</span></span><span class=line><span class=cl>|      |                |     |
</span></span><span class=line><span class=cl>|      |                | do1 |
</span></span><span class=line><span class=cl>|      |                |     |
</span></span><span class=line><span class=cl>|      |                +-----+
</span></span><span class=line><span class=cl>|      |                |     |
</span></span><span class=line><span class=cl>|      |                | do2 |
</span></span><span class=line><span class=cl>|      |                +-+---+
</span></span><span class=line><span class=cl>|      |                  |
</span></span><span class=line><span class=cl>|      |                  |
</span></span><span class=line><span class=cl>| A    |                  |
</span></span><span class=line><span class=cl>+------+                  |
</span></span><span class=line><span class=cl>|      |                  |
</span></span><span class=line><span class=cl>|      |                  |
</span></span><span class=line><span class=cl>|      |                  |
</span></span><span class=line><span class=cl>|      | &lt;----------------+
</span></span><span class=line><span class=cl>|      |
</span></span><span class=line><span class=cl>|      |
</span></span><span class=line><span class=cl>|      |
</span></span><span class=line><span class=cl>+------+
</span></span></code></pre></td></tr></table></div></div><p>早期 Rust 异步写法示意：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id_rpc</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_server</span><span class=p>).</span><span class=n>and_then</span><span class=p>(</span><span class=o>|</span><span class=n>id</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>get_row</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=n>map</span><span class=p>(</span><span class=o>|</span><span class=n>row</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>json</span>::<span class=n>encode</span><span class=p>(</span><span class=n>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=n>and_then</span><span class=p>(</span><span class=o>|</span><span class=n>encoded</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>write_string</span><span class=p>(</span><span class=n>my_socket</span><span class=p>,</span><span class=w> </span><span class=n>encoded</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这样写会存在大量内嵌 Future，开发体验不好。</p><p>引入 async/await 之后：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id_rpc</span><span class=p>(</span><span class=o>&amp;</span><span class=n>my_server</span><span class=p>).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_row</span><span class=p>(</span><span class=n>id</span><span class=p>).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>encoded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>json</span>::<span class=n>encode</span><span class=p>(</span><span class=n>row</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>write_string</span><span class=p>(</span><span class=n>my_socket</span><span class=p>,</span><span class=w> </span><span class=n>encoded</span><span class=p>).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>拥有了和同步代码一致的体验。</p><p><strong>异步任务可看作是一种绿色线程</strong></p><p>查看 README 相关图示</p><p><img src=/img/2022-07-07-Rust-async/process_thread_coroutine.png loading=lazy alt=process></p><p><img src=/img/2022-07-07-Rust-async/swap_problem.jpg loading=lazy alt=process></p><p>可以说，异步任务的行为是模仿 线程 来抽象。</p><ol><li>线程在进程内，异步任务在线程内。</li><li>线程可被调度切换（Linux默认抢占式），异步任务也可以被调度（协作式而非抢占式）。区别在于，异步任务只在用户态，没有线程的上下文切换开销。</li><li>线程有上下文信息，异步任务也有上下文信息。</li><li>线程间可以通信，异步任务之间也可以通信。</li><li>线程间有竞争，异步任务之间也有竞争。</li></ol><p>整个异步编程概念，包括异步语法、异步运行时都是围绕如何建立这种「绿色线程」抽象而成的。</p><p>什么是<a class=link href=https://zh.m.wikipedia.org/zh-hans/%E7%BB%BF%E8%89%B2%E7%BA%BF%E7%A8%8B target=_blank rel=noopener>绿色线程</a>？</p><blockquote><p>在计算机程序设计中，<strong>绿色线程</strong>是一种由<a class=link href=https://zh.m.wikipedia.org/wiki/%e8%bf%90%e8%a1%8c%e6%97%b6%e7%b3%bb%e7%bb%9f target=_blank rel=noopener>运行环境</a>或<a class=link href=https://zh.m.wikipedia.org/wiki/%e8%99%9b%e6%93%ac%e6%a9%9f%e5%99%a8 target=_blank rel=noopener>虚拟机</a>调度，而不是由本地底层操作系统调度的线程。绿色线程并不依赖底层的系统功能，模拟实现了多线程的运行，这种线程的管理调配发生在用户空间而不是内核空间，所以它们可以在没有原生线程支持的环境中工作。</p></blockquote><h2 id=future和futures-rs介绍>Future和Futures-rs介绍</h2><p><a class=link href=https://doc.rust-lang.org/std/future/index.html target=_blank rel=noopener>Future</a>：提供了异步计算。</p><p>Future trait：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>trait</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Output</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>poll</span><span class=p>(</span><span class=bp>self</span>: <span class=nc>Pin</span><span class=o>&lt;&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>cx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Context</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Poll</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Output</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>其中poll方法很重要，尝试去将future得到一个最终的值。如果最终的值没有准备好，也不会进行阻塞。</p><p><a class=link href=https://doc.rust-lang.org/std/task/index.html target=_blank rel=noopener>task</a>：可以理解为创建绿色线程。</p><p>其中重要的是Enum <a class=link href=https://doc.rust-lang.org/std/index.html target=_blank rel=noopener>std</a>::<a class=link href=https://doc.rust-lang.org/std/task/index.html target=_blank rel=noopener>task</a>::<a class=link href=https://doc.rust-lang.org/std/task/enum.Poll.html# target=_blank rel=noopener>Poll</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>Poll</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Ready</span><span class=p>(</span><span class=n>T</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Pending</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/rust-lang/futures-rs target=_blank rel=noopener>futures-rs</a>：对future做了扩展。</p><h2 id=编写异步echo服务>编写异步echo服务</h2><p>什么是<a class=link href=https://zh.m.wikipedia.org/zh-hans/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6 target=_blank rel=noopener>文件描述符</a>？</p><blockquote><p><strong>文件描述符</strong>（File descriptor）是计算机科学中的一个术语，是一个用于表述指向<a class=link href=https://zh.m.wikipedia.org/wiki/%e6%96%87%e4%bb%b6 target=_blank rel=noopener>文件</a>的引用的抽象化概念。</p><p>文件描述符在形式上是一个非负整数。实际上，它是一个索引值，指向<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%86%85%e6%a0%b8 target=_blank rel=noopener>内核</a>为每一个<a class=link href=https://zh.m.wikipedia.org/wiki/%e8%bf%9b%e7%a8%8b target=_blank rel=noopener>进程</a>所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。在<a class=link href=https://zh.m.wikipedia.org/wiki/%e7%a8%8b%e5%ba%8f%e8%ae%be%e8%ae%a1 target=_blank rel=noopener>程序设计</a>中，一些涉及底层的程序编写往往会围绕着文件描述符展开。但是文件描述符这一概念往往只适用于<a class=link href=https://zh.m.wikipedia.org/wiki/UNIX target=_blank rel=noopener>UNIX</a>、<a class=link href=https://zh.m.wikipedia.org/wiki/Linux target=_blank rel=noopener>Linux</a>这样的操作系统。</p></blockquote><p>代码见<a class=link href=https://github.com/ZhangHanDong/inviting-rust/tree/master/async-echo-server target=_blank rel=noopener>async-echo-server</a>。</p><p>流程图：</p><p><img src=/img/2022-07-07-Rust-async/image-20220816104218814.png loading=lazy alt=image-20220816104218814></p><p>先看看文件的结构：</p><ul><li>main</li><li>epoll</li><li>tcp_listener</li><li>executor</li><li>reactor</li><li>util</li></ul><p>tcp_listener:</p><p><img src=/img/2022-07-07-Rust-async/image-20220816104414073.png loading=lazy alt=image-20220816104414073></p><p>这里主要是几个异步计算的实现，也就是AccpectFuture、ReadFuture、WriteFuture。</p><p>epoll：Linux下epoll的封装。</p><p><img src=/img/2022-07-07-Rust-async/image-20220816104808295.png loading=lazy alt=image-20220816104808295></p><p>主要就是调用系统调用，重要的是epoll的三个方法epoll_create、epoll_ctl、epoll_wait。</p><p>executor：执行器，怎样调度这些绿色线程，如何执行任务。</p><p><img src=/img/2022-07-07-Rust-async/image-20220816105016908.png loading=lazy alt=image-20220816105016908></p><p>reactor：添加事件，检测到事件后唤醒事件，让执行器去执行。</p><p><img src=/img/2022-07-07-Rust-async/image-20220816105146577.png loading=lazy alt=image-20220816105146577></p><h2 id=深入理解异步task模型>深入理解异步Task模型</h2><p>回顾 Rust 异步 task 模型</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>    +------------------------------------------------------------------+
</span></span><span class=line><span class=cl>    |                                                                  |
</span></span><span class=line><span class=cl>    |    +--------------------------------------------------------+    |
</span></span><span class=line><span class=cl>    |    |                                                        |    |
</span></span><span class=line><span class=cl>    |    |   +-------------------------------------------------+  |    |
</span></span><span class=line><span class=cl>    |    |   |-------------+ +----------+ +--------------+     |  |    |
</span></span><span class=line><span class=cl>    |    |   || futureobj  | | futureobj| |  futureobj   |     |  |    |
</span></span><span class=line><span class=cl>    |    |   +-------------+ +----------+ +--------------+     |  |    |
</span></span><span class=line><span class=cl>    |    |   | 协 程  task                                      |  |    |
</span></span><span class=line><span class=cl>    |    |   +-------------------------------------------------+  |    |
</span></span><span class=line><span class=cl>    |    |                                                        |    |
</span></span><span class=line><span class=cl>    |    | 线 程                                                   |    |
</span></span><span class=line><span class=cl>    |    +--------------------------------------------------------+    |
</span></span><span class=line><span class=cl>    |                                                                  |
</span></span><span class=line><span class=cl>    |                                                                  |
</span></span><span class=line><span class=cl>    |    +--------------------------------------------------------+    |
</span></span><span class=line><span class=cl>    |    |  +--------------------------------------------------+  |    |
</span></span><span class=line><span class=cl>    |    |  |                                                  |  |    |
</span></span><span class=line><span class=cl>    |    |  |   +------------+ +-------------------------------+  |    |
</span></span><span class=line><span class=cl>    |    |  |   | futureobj  | |  futureobj      || futureobj ||  |    |
</span></span><span class=line><span class=cl>    |    |  |   +------------+ +-------------------------------+  |    |
</span></span><span class=line><span class=cl>    |    |  |  协 程 task                                      |  |    |
</span></span><span class=line><span class=cl>    |    |  +--------------------------------------------------+  |    |
</span></span><span class=line><span class=cl>    |    | 线 程                                                   |    |
</span></span><span class=line><span class=cl>    |    +--------------------------------------------------------+    |
</span></span><span class=line><span class=cl>    |                                                                  |
</span></span><span class=line><span class=cl>    | 进  程                                                            |
</span></span><span class=line><span class=cl>    +------------------------------------------------------------------+
</span></span></code></pre></td></tr></table></div></div><p>什么是<a class=link href=https://zh.m.wikipedia.org/zh-hans/%E5%8D%8F%E7%A8%8B target=_blank rel=noopener>协程</a>？</p><blockquote><p><strong>协程</strong>（英语：coroutine）是计算机程序的一类组件，推广了<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%8d%8f%e4%bd%9c%e5%bc%8f%e5%a4%9a%e4%bb%bb%e5%8a%a1 target=_blank rel=noopener>协作式多任务</a>的<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%ad%90%e4%be%8b%e7%a8%8b target=_blank rel=noopener>子例程</a>，允许执行被挂起与被恢复。相对子例程而言，协程更为一般和灵活，但在实践中使用没有子例程那样广泛。协程更适合于用来实现彼此熟悉的程序组件，如<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%8d%8f%e4%bd%9c%e5%bc%8f%e5%a4%9a%e4%bb%bb%e5%8a%a1 target=_blank rel=noopener>协作式多任务</a>、<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86 target=_blank rel=noopener>异常处理</a>、<a class=link href=https://zh.m.wikipedia.org/wiki/%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af target=_blank rel=noopener>事件循环</a>、<a class=link href=https://zh.m.wikipedia.org/wiki/%e8%bf%ad%e4%bb%a3%e5%99%a8 target=_blank rel=noopener>迭代器</a>、<a class=link href=https://zh.m.wikipedia.org/wiki/%e6%83%b0%e6%80%a7%e6%b1%82%e5%80%bc target=_blank rel=noopener>无限列表</a>和<a class=link href=https://zh.m.wikipedia.org/wiki/%e7%ae%a1%e9%81%93_%28%e8%bd%af%e4%bb%b6%29 target=_blank rel=noopener>管道</a>。</p></blockquote><p>同线程的比较</p><blockquote><p>协程非常类似于<a class=link href=https://zh.m.wikipedia.org/wiki/%e7%ba%bf%e7%a8%8b target=_blank rel=noopener>线程</a>。但是协程是<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%8d%8f%e4%bd%9c%e5%bc%8f%e5%a4%9a%e4%bb%bb%e5%8a%a1 target=_blank rel=noopener>协作式</a>多任务的，而线程典型是<a class=link href=https://zh.m.wikipedia.org/wiki/%e6%8a%a2%e5%8d%a0%e5%bc%8f%e5%a4%9a%e4%bb%bb%e5%8a%a1 target=_blank rel=noopener>抢占式</a><a class=link href=https://zh.m.wikipedia.org/wiki/%e5%a4%9a%e4%bb%bb%e5%8a%a1 target=_blank rel=noopener>多任务</a>的。这意味着协程提供<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%b9%b6%e5%8f%91%e6%80%a7 target=_blank rel=noopener>并发性</a>而非<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%b9%b6%e8%a1%8c%e8%ae%a1%e7%ae%97 target=_blank rel=noopener>并行性</a>。协程超过线程的好处是它们可以用于<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%ae%9e%e6%97%b6%e8%ae%a1%e7%ae%97 target=_blank rel=noopener>硬性实时</a>的语境（在协程之间的<a class=link href=https://zh.m.wikipedia.org/wiki/%e4%b8%8a%e4%b8%8b%e6%96%87%e5%88%87%e6%8d%a2 target=_blank rel=noopener>切换</a>不需要涉及任何<a class=link href=https://zh.m.wikipedia.org/wiki/%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8 target=_blank rel=noopener>系统调用</a>或任何<a class=link href=https://zh.m.wikipedia.org/wiki/%e9%98%bb%e5%a1%9e_%28%e8%ae%a1%e7%ae%97%29 target=_blank rel=noopener>阻塞</a>调用），这里不需要用来守卫<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%85%b3%e9%94%ae%e5%8c%ba%e6%ae%b5 target=_blank rel=noopener>关键区段</a>的同步性原语（primitive）比如<a class=link href=https://zh.m.wikipedia.org/wiki/%e4%ba%92%e6%96%a5%e9%94%81 target=_blank rel=noopener>互斥锁</a>、信号量等，并且不需要来自操作系统的支持。有可能以一种对调用代码透明的方式，使用抢占式调度的线程实现协程，但是会失去某些利益（特别是对硬性实时操作的适合性和相对廉价的相互之间切换）。</p><p><a class=link href=https://zh.m.wikipedia.org/wiki/%e7%ba%bf%e7%a8%8b target=_blank rel=noopener>线程</a>是<a class=link href=https://zh.m.wikipedia.org/wiki/%e5%8d%8f%e4%bd%9c%e5%bc%8f%e5%a4%9a%e4%bb%bb%e5%8a%a1 target=_blank rel=noopener>协作式</a>多任务的轻量级线程，本质上描述了同协程一样的概念。其区别，如果一定要说有的话，是协程是语言层级的构造，可看作一种形式的<a class=link href=https://zh.m.wikipedia.org/wiki/%e6%8e%a7%e5%88%b6%e6%b5%81 target=_blank rel=noopener>控制流</a>，而线程是系统层级的构造，可看作恰巧没有并行运行的线程。这两个概念谁有优先权是争议性的：线程可看作为协程的一种实现[<a class=link href=https://zh.m.wikipedia.org/zh-hans/%e5%8d%8f%e7%a8%8b#cite_note-flounder-6 target=_blank rel=noopener>6]</a>，也可看作实现协程的基底[<a class=link href=https://zh.m.wikipedia.org/zh-hans/%e5%8d%8f%e7%a8%8b#cite_note-msdn-wrap-7 target=_blank rel=noopener>7]</a>。</p></blockquote><ol><li>理解 leaf-futures vs Non-leaf-futures (async/await)<ul><li>叶子futures：像代码示例中的AccpectFuture、ReadFuture、WriteFuture，要和Reactor打交道，比较底层。</li><li>非叶子futures：用async或者await实现，业务层面的。</li></ul></li><li>理解 Waker：</li></ol><blockquote><p>当事件源注册该Future将在某个事件上等待时，它必须存储唤醒程序，以便以后可以调用唤醒来开始唤醒阶段。 为了引入并发性，能够同时等待多个事件非常重要，因此唤醒器不可能由单个事件源唯一拥有。 结果，Waker类型需要是实现 Clone 的。</p></blockquote><ul><li><p>Struct <a class=link href=https://doc.rust-lang.org/std/index.html target=_blank rel=noopener>std</a>::<a class=link href=https://doc.rust-lang.org/std/task/index.html target=_blank rel=noopener>task</a>::<a class=link href=https://doc.rust-lang.org/std/task/struct.Waker.html# target=_blank rel=noopener>Waker</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[repr(transparent)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[stable(feature = </span><span class=s>&#34;futures_api&#34;</span><span class=cp>, since = </span><span class=s>&#34;1.36.0&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Waker</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>waker</span>: <span class=nc>RawWaker</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Waker 可以唤醒一个任务，通过通知执行器。</p><p>Waker实现了一些trait。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[stable(feature = </span><span class=s>&#34;futures_api&#34;</span><span class=cp>, since = </span><span class=s>&#34;1.36.0&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=nb>Unpin</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Waker</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[stable(feature = </span><span class=s>&#34;futures_api&#34;</span><span class=cp>, since = </span><span class=s>&#34;1.36.0&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>unsafe</span><span class=w> </span><span class=k>impl</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Waker</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[stable(feature = </span><span class=s>&#34;futures_api&#34;</span><span class=cp>, since = </span><span class=s>&#34;1.36.0&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>unsafe</span><span class=w> </span><span class=k>impl</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Waker</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(PartialEq, Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[stable(feature = </span><span class=s>&#34;futures_api&#34;</span><span class=cp>, since = </span><span class=s>&#34;1.36.0&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>RawWaker</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// A data pointer, which can be used to store arbitrary data as required
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// by the executor. This could be e.g. a type-erased pointer to an `Arc`
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// that is associated with the task.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// The value of this field gets passed to all functions that are part of
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// the vtable as the first parameter.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>data</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Virtual function pointer table that customizes the behavior of this waker.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>vtable</span>: <span class=kp>&amp;</span><span class=nb>&#39;static</span> <span class=nc>RawWakerVTable</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里Rawwaker有两个内容，一个data可以保存上下文，一个vtable是虚表。</p></li></ul><ol start=3><li>理解并发（waker 并发 和 poll 并发）</li></ol><p>深入 Futures-rs:</p><ul><li><a class=link href=https://doc.rust-lang.org/std/future/index.html target=_blank rel=noopener>Future</a> and <a class=link href=https://doc.rust-lang.org/std/task/index.html target=_blank rel=noopener>task</a></li><li><a class=link href=https://github.com/rust-lang/futures-rs target=_blank rel=noopener>futures-rs</a></li><li><a class=link href=https://github.com/smol-rs/futures-lite target=_blank rel=noopener>futures-lite</a></li></ul><h2 id=async-await语法背后>async-await语法背后</h2><h3 id=历史>历史</h3><p>处理异步事件的三种方式：</p><ul><li>Callback</li><li>Promise/Future</li><li>async/await</li></ul><p>async/await 是目前体验最好的方式，Rust 要支持它并不容易。</p><h3 id=asyncawait-语法介绍>async/await 语法介绍</h3><p>参考：<a class=link href=https://rust-lang.github.io/async-book/01_getting_started/01_chapter.html target=_blank rel=noopener>Asynchronous Programming in Rust</a></p><p><code>async</code> 两种用法：<code>async fn </code>函数 和 <code>async {}</code> 块。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// async 函数，真正会返回 `Future&lt;Output = u8&gt;`，而不是表面看上去的 `u8`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>foo</span><span class=p>()</span><span class=w> </span>-&gt; <span class=kt>u8</span> <span class=p>{</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// async 块用法，返回 `impl Future&lt;Output = u8&gt;`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fn</span> <span class=nf>bar</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 这里 `async` 块返回  `impl Future&lt;Output = u8&gt;`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=n>foo</span><span class=p>().</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>await</code> 将暂停当前函数的执行，直到执行者将 Future 结束为止。这为其他 Future 任务提供了计算的机会。</p><h2 id=生成器>生成器</h2><p>Future 底层实现依赖于 生成器。 <code>async/await</code> 对应底层生成器 <code>resume/yield</code> 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#![feature(generators, generator_trait)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=n>Generator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kr>yield</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kr>yield</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kr>yield</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// for _ in 0..4 {
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>//     // 为了给嵌入式支持异步，多传入了一个空的unit给resume方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>//     let c = Pin::new(&amp;mut gen).resume(());
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>//     println!(&#34;{:?}&#34;, c);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=p>).</span><span class=n>resume</span><span class=p>(());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=p>).</span><span class=n>resume</span><span class=p>(());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=p>).</span><span class=n>resume</span><span class=p>(());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=p>).</span><span class=n>resume</span><span class=p>(());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>生成等价代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#![allow(unused)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#![feature(generators, generator_trait)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=p>{</span><span class=n>Generator</span><span class=p>,</span><span class=w> </span><span class=n>GeneratorState</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>enum</span> <span class=nc>__Gen</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// (0) 初始状态
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Start</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// (1) resume方法执行以后
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>State1</span><span class=p>(</span><span class=n>State1</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// (2) resume方法执行以后
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>State2</span><span class=p>(</span><span class=n>State2</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// (3) resume方法执行以后
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>State3</span><span class=p>(</span><span class=n>State3</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// (4) resume方法执行以后，正好完成
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Done</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>State1</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>x</span>: <span class=kt>u64</span> <span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>State2</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>x</span>: <span class=kt>u64</span> <span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>State3</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>x</span>: <span class=kt>u64</span> <span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Generator</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>__Gen</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Yield</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Return</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>resume</span><span class=p>(</span><span class=bp>self</span>: <span class=nc>Pin</span><span class=o>&lt;&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>_</span>: <span class=p>())</span><span class=w> </span>-&gt; <span class=nc>GeneratorState</span><span class=o>&lt;</span><span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=kt>u64</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>mut_ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>get_mut</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>std</span>::<span class=n>mem</span>::<span class=n>replace</span><span class=p>(</span><span class=n>mut_ref</span><span class=p>,</span><span class=w> </span><span class=n>__Gen</span>::<span class=n>Done</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>__Gen</span>::<span class=n>Start</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>*</span><span class=n>mut_ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>__Gen</span>::<span class=n>State1</span><span class=p>(</span><span class=n>State1</span><span class=p>{</span><span class=n>x</span>: <span class=mi>1</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>GeneratorState</span>::<span class=n>Yielded</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>__Gen</span>::<span class=n>State1</span><span class=p>(</span><span class=n>State1</span><span class=p>{</span><span class=n>x</span>: <span class=mi>1</span><span class=p>})</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>*</span><span class=n>mut_ref</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>__Gen</span>::<span class=n>State2</span><span class=p>(</span><span class=n>State2</span><span class=p>{</span><span class=n>x</span>: <span class=mi>2</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>GeneratorState</span>::<span class=n>Yielded</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>__Gen</span>::<span class=n>State2</span><span class=p>(</span><span class=n>State2</span><span class=p>{</span><span class=n>x</span>: <span class=mi>2</span><span class=p>})</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>*</span><span class=n>mut_ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>__Gen</span>::<span class=n>State3</span><span class=p>(</span><span class=n>State3</span><span class=p>{</span><span class=n>x</span>: <span class=mi>3</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>GeneratorState</span>::<span class=n>Yielded</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>__Gen</span>::<span class=n>State3</span><span class=p>(</span><span class=n>State3</span><span class=p>{</span><span class=n>x</span>: <span class=mi>3</span><span class=p>})</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>*</span><span class=n>mut_ref</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>__Gen</span>::<span class=n>Done</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>GeneratorState</span>::<span class=n>Complete</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;generator resumed after completion&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>__Gen</span>::<span class=n>Start</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=mi>4</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=k>unsafe</span><span class=p>{</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=p>).</span><span class=n>resume</span><span class=p>(())});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>生成器基本用法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#![allow(unused)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#![feature(generators, generator_trait)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=n>Generator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>up_to</span><span class=p>(</span><span class=n>limit</span>: <span class=kt>u64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Generator</span><span class=o>&lt;</span><span class=n>Yield</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>Return</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u64</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=n>limit</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kr>yield</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>limit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>up_to</span><span class=p>(</span><span class=n>a</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..=</span><span class=mi>10</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>b</span><span class=p>).</span><span class=n>resume</span><span class=p>(());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>生成器变身为迭代器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#![allow(unused)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#![feature(generators, generator_trait)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=p>{</span><span class=n>Generator</span><span class=p>,</span><span class=w> </span><span class=n>GeneratorState</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>up_to</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Generator</span><span class=o>&lt;</span><span class=n>Yield</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>Return</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kr>yield</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>up_to</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=mi>10</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=p>).</span><span class=n>resume</span><span class=p>(())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>GeneratorState</span>::<span class=n>Yielded</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Completed&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>生成器变身为 Future:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#![allow(unused)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#![feature(generators, generator_trait)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=p>{</span><span class=n>Generator</span><span class=p>,</span><span class=w> </span><span class=n>GeneratorState</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>up_to</span><span class=p>(</span><span class=n>limit</span>: <span class=kt>u64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Generator</span><span class=o>&lt;</span><span class=n>Yield</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(),</span><span class=w> </span><span class=n>Return</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=n>limit</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kr>yield</span><span class=w> </span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>limit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>limit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>up_to</span><span class=p>(</span><span class=n>limit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..=</span><span class=n>limit</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>gen</span><span class=p>).</span><span class=n>resume</span><span class=p>(())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>GeneratorState</span>::<span class=n>Yielded</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;resume </span><span class=si>{:?}</span><span class=s> : Pending&#34;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>GeneratorState</span>::<span class=n>Complete</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;resume </span><span class=si>{:?}</span><span class=s> : Ready&#34;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在标准库Future内部，可以从Generator转换为Future。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[lang = </span><span class=s>&#34;from_generator&#34;</span><span class=cp>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[doc(hidden)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[unstable(feature = </span><span class=s>&#34;gen_future&#34;</span><span class=cp>, issue = </span><span class=s>&#34;50547&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[rustc_const_unstable(feature = </span><span class=s>&#34;gen_future&#34;</span><span class=cp>, issue = </span><span class=s>&#34;50547&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[inline]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>fn</span> <span class=nf>from_generator</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>gen</span>: <span class=nc>T</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>T</span>::<span class=n>Return</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>T</span>: <span class=nc>Generator</span><span class=o>&lt;</span><span class=n>ResumeTy</span><span class=p>,</span><span class=w> </span><span class=n>Yield</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[rustc_diagnostic_item = </span><span class=s>&#34;gen_future&#34;</span><span class=cp>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>struct</span> <span class=nc>GenFuture</span><span class=o>&lt;</span><span class=n>T</span>: <span class=nc>Generator</span><span class=o>&lt;</span><span class=n>ResumeTy</span><span class=p>,</span><span class=w> </span><span class=n>Yield</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>T</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// We rely on the fact that async/await futures are immovable in order to create
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// self-referential borrows in the underlying generator.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>impl</span><span class=o>&lt;</span><span class=n>T</span>: <span class=nc>Generator</span><span class=o>&lt;</span><span class=n>ResumeTy</span><span class=p>,</span><span class=w> </span><span class=n>Yield</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=o>!</span><span class=nb>Unpin</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>GenFuture</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>impl</span><span class=o>&lt;</span><span class=n>T</span>: <span class=nc>Generator</span><span class=o>&lt;</span><span class=n>ResumeTy</span><span class=p>,</span><span class=w> </span><span class=n>Yield</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>GenFuture</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>type</span> <span class=nc>Output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>T</span>::<span class=n>Return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>fn</span> <span class=nf>poll</span><span class=p>(</span><span class=bp>self</span>: <span class=nc>Pin</span><span class=o>&lt;&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>cx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Context</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Poll</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Output</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// SAFETY: Safe because we&#39;re !Unpin + !Drop, and this is just a field projection.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>gen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>Pin</span>::<span class=n>map_unchecked_mut</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=o>|</span><span class=n>s</span><span class=o>|</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Resume the generator, turning the `&amp;mut Context` into a `NonNull` raw pointer. The
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// `.await` lowering will safely cast that back to a `&amp;mut Context`.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=k>match</span><span class=w> </span><span class=n>gen</span><span class=p>.</span><span class=n>resume</span><span class=p>(</span><span class=n>ResumeTy</span><span class=p>(</span><span class=n>NonNull</span>::<span class=n>from</span><span class=p>(</span><span class=n>cx</span><span class=p>).</span><span class=n>cast</span>::<span class=o>&lt;</span><span class=n>Context</span><span class=o>&lt;</span><span class=nb>&#39;static</span><span class=o>&gt;&gt;</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>GeneratorState</span>::<span class=n>Yielded</span><span class=p>(())</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Poll</span>::<span class=n>Pending</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>GeneratorState</span>::<span class=n>Complete</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Poll</span>::<span class=n>Ready</span><span class=p>(</span><span class=n>x</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GenFuture</span><span class=p>(</span><span class=n>gen</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=no-std异步生态介绍>no-std异步生态介绍</h2><ul><li><a class=link href=https://github.com/irrustible/futures-micro target=_blank rel=noopener>futures-micro</a> 对futures的最小的实现</li><li><a class=link href=https://github.com/embassy-rs/embassy target=_blank rel=noopener>embassy</a> 嵌入式生态</li><li><a class=link href=https://github.com/richardanaya/executor target=_blank rel=noopener>executor for no-std</a> no-std的执行器，可以用在嵌入式及WebAssembly上</li></ul><h2 id=一个异步缓存代码实现>一个异步缓存代码实现</h2><p>代码见<a class=link href=https://github.com/ChaosStudyGroup/retainer target=_blank rel=noopener>retainer</a>。</p><p>下面分析下代码结构，首先是 entry.rs。</p><p>缓存的entry结构：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>CacheEntry</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>value</span>: <span class=nc>V</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>expiration</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>CacheExpiration</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>有相应的值value以及过期时间expiration，这里过期时间是一个Option，因为有的可以没有过期时间。</p><p>CacheExpiration：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>CacheExpiration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>instant</span>: <span class=nc>Instant</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>代表缓存中的过期时间，这里对Instant有一个包装，方便实现一些方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>CacheEntryReadGuard</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>entry</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>CacheEntry</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>marker</span>: <span class=nc>PhantomData</span><span class=o>&lt;&amp;</span><span class=na>&#39;a</span><span class=w> </span><span class=n>CacheEntry</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>对底层缓存结构的引用的一个读保护。当使用锁的时候，这个结构可以返回一个指向内部缓存 entries 的引用，也就是一个指针。同时CacheEntryReadGuard实现了Send和Sync。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// Stores a raw pointer to `T`, so if `T` is `Sync`, the lock guard over `T` is `Send`.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>unsafe</span><span class=w> </span><span class=k>impl</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>CacheEntryReadGuard</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>V</span>: <span class=nb>Sized</span> <span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>unsafe</span><span class=w> </span><span class=k>impl</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>CacheEntryReadGuard</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>V</span>: <span class=nb>Sized</span> <span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>cache.rs</p><p>缓存结构：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Cache</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>store</span>: <span class=nc>RwLock</span><span class=o>&lt;</span><span class=n>BTreeMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=w> </span><span class=n>CacheEntry</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>label</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>监控是否有过期缓存：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>monitor</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>sample</span>: <span class=kt>usize</span><span class=p>,</span><span class=w> </span><span class=n>threshold</span>: <span class=kt>f64</span><span class=p>,</span><span class=w> </span><span class=n>frequency</span>: <span class=nc>Duration</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>interval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Interval</span>::<span class=n>platform_new</span><span class=p>(</span><span class=n>frequency</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>interval</span><span class=p>.</span><span class=n>as_mut</span><span class=p>().</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>purge</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span><span class=w> </span><span class=n>threshold</span><span class=p>).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看到 purge 函数最终实现异步清理。</p><p>这里说下Redis的缓存过期处理方式：</p><ul><li>惰性删除。当查找一个key，过期时删除。</li><li>定期删除。每隔一段时间，随机取一定数量的key，看看缓存中是否存在，如果到达一定的阈值比如20%已经过期了，则进行删除，如果没有到达该阈值，则不删除。</li></ul><p>关于Redis缓存，参见<a class=link href=https://segmentfault.com/a/1190000039020626 target=_blank rel=noopener>Redis缓存总结：淘汰机制、缓存雪崩、数据不一致&mldr;.</a>。</p><h2 id=异步运行时生态>异步运行时生态</h2><ul><li>tokio 和rust异步标准有些差异，成熟</li><li>async-std 让开发者顺利编写异步，对标准库的异步</li><li>smol 轻量级，比较通用</li><li>glommio 生产级应用</li><li>bastion 高可用分布式容错框架</li></ul><h2 id=smol运行时>smol运行时</h2><p>先看看smol中的Cargo.toml。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>async-channel</span> <span class=p>=</span> <span class=s2>&#34;1.4.2&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>async-executor</span> <span class=p>=</span> <span class=s2>&#34;1.3.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>async-fs</span> <span class=p>=</span> <span class=s2>&#34;1.3.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>async-io</span> <span class=p>=</span> <span class=s2>&#34;1.1.2&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>async-lock</span> <span class=p>=</span> <span class=s2>&#34;2.3.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>async-net</span> <span class=p>=</span> <span class=s2>&#34;1.4.3&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>async-process</span> <span class=p>=</span> <span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>blocking</span> <span class=p>=</span> <span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>futures-lite</span> <span class=p>=</span> <span class=s2>&#34;1.11.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>once_cell</span> <span class=p>=</span> <span class=s2>&#34;1.4.1&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>smol对这些组件做了一个整合，这些组件也可以单独使用。</p><h3 id=smol文档httpsdocsrssmollatestsmol><a class=link href=https://docs.rs/smol/latest/smol/ target=_blank rel=noopener>smol文档</a></h3><p><a class=link href=https://docs.rs/smol/latest/smol/#modules target=_blank rel=noopener>Modules</a></p><div class=table-wrapper><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><a class=link href=https://docs.rs/smol/latest/smol/channel/index.html target=_blank rel=noopener>channel</a></td><td>An async multi-producer multi-consumer channel.</td></tr><tr><td><a class=link href=https://docs.rs/smol/latest/smol/fs/index.html target=_blank rel=noopener>fs</a></td><td>Async filesystem primitives.</td></tr><tr><td><a class=link href=https://docs.rs/smol/latest/smol/future/index.html target=_blank rel=noopener>future</a></td><td>Combinators for the <a class=link href=https://docs.rs/smol/latest/smol/prelude/trait.Future.html target=_blank rel=noopener><code>Future</code></a> trait.</td></tr><tr><td><a class=link href=https://docs.rs/smol/latest/smol/io/index.html target=_blank rel=noopener>io</a></td><td>Tools and combinators for I/O.</td></tr><tr><td><a class=link href=https://docs.rs/smol/latest/smol/lock/index.html target=_blank rel=noopener>lock</a></td><td>Async synchronization primitives.</td></tr><tr><td><a class=link href=https://docs.rs/smol/latest/smol/net/index.html target=_blank rel=noopener>net</a></td><td>Async networking primitives for TCP/UDP/Unix communication.</td></tr><tr><td><a class=link href=https://docs.rs/smol/latest/smol/prelude/index.html target=_blank rel=noopener>prelude</a></td><td>Traits <a class=link href=https://docs.rs/smol/latest/smol/prelude/trait.Future.html target=_blank rel=noopener><code>Future</code></a>, <a class=link href=https://docs.rs/smol/latest/smol/stream/trait.Stream.html target=_blank rel=noopener><code>Stream</code></a>, <a class=link href=https://docs.rs/smol/latest/smol/prelude/trait.AsyncRead.html target=_blank rel=noopener><code>AsyncRead</code></a>, <a class=link href=https://docs.rs/smol/latest/smol/prelude/trait.AsyncWrite.html target=_blank rel=noopener><code>AsyncWrite</code></a>, <a class=link href=https://docs.rs/smol/latest/smol/prelude/trait.AsyncBufRead.html target=_blank rel=noopener><code>AsyncBufRead</code></a>, <a class=link href=https://docs.rs/smol/latest/smol/prelude/trait.AsyncSeek.html target=_blank rel=noopener><code>AsyncSeek</code></a>, and their extensions.</td></tr><tr><td><a class=link href=https://docs.rs/smol/latest/smol/process/index.html target=_blank rel=noopener>process</a></td><td>Async interface for working with processes.</td></tr><tr><td><a class=link href=https://docs.rs/smol/latest/smol/stream/index.html target=_blank rel=noopener>stream</a></td><td>Combinators for the <a class=link href=https://docs.rs/smol/latest/smol/stream/trait.Stream.html target=_blank rel=noopener><code>Stream</code></a> trait.</td></tr></tbody></table></div><p><a class=link href=https://docs.rs/smol/latest/smol/#structs target=_blank rel=noopener>Structs</a></p><div class=table-wrapper><table><thead><tr><th style=text-align:left>Name</th><th>Description</th></tr></thead><tbody><tr><td style=text-align:left><a class=link href=https://docs.rs/smol/latest/smol/struct.Async.html target=_blank rel=noopener>Async</a></td><td>Async adapter for I/O types. 异步适配器，可以将阻塞IO变为非阻塞IO。</td></tr><tr><td style=text-align:left><a class=link href=https://docs.rs/smol/latest/smol/struct.Executor.html target=_blank rel=noopener>Executor</a></td><td>An async executor. 异步执行器。</td></tr><tr><td style=text-align:left><a class=link href=https://docs.rs/smol/latest/smol/struct.LocalExecutor.html target=_blank rel=noopener>LocalExecutor</a></td><td>A thread-local executor. 单线程执行器。</td></tr><tr><td style=text-align:left><a class=link href=https://docs.rs/smol/latest/smol/struct.Task.html target=_blank rel=noopener>Task</a></td><td>A spawned task. 任务。</td></tr><tr><td style=text-align:left><a class=link href=https://docs.rs/smol/latest/smol/struct.Timer.html target=_blank rel=noopener>Timer</a></td><td>A future that expires at a point in time.</td></tr><tr><td style=text-align:left><a class=link href=https://docs.rs/smol/latest/smol/struct.Unblock.html target=_blank rel=noopener>Unblock</a></td><td>Runs blocking I/O on a thread pool.</td></tr></tbody></table></div><h3 id=smol源码>smol源码</h3><p>src/spawn.rs</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>once_cell</span>::<span class=n>sync</span>::<span class=n>Lazy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// 将异步任务加入到 task 中，交给 Global 执行器
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>spawn</span><span class=o>&lt;</span><span class=n>T</span>: <span class=nb>Send</span> <span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=o>&gt;</span><span class=p>(</span><span class=n>future</span>: <span class=nc>impl</span><span class=w> </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Task</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=no>GLOBAL</span>: <span class=nc>Lazy</span><span class=o>&lt;</span><span class=n>Executor</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Lazy</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>num_threads</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Parse SMOL_THREADS or default to 1.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>std</span>::<span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;SMOL_THREADS&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>and_then</span><span class=p>(</span><span class=o>|</span><span class=n>s</span><span class=o>|</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>parse</span><span class=p>().</span><span class=n>ok</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>unwrap_or</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>1</span><span class=o>..=</span><span class=n>num_threads</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>thread</span>::<span class=n>Builder</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>name</span><span class=p>(</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;smol-</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// catch_unwind 方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=c1>// 可以捕获栈展开，运行panic线程存活并继续运行。使用标准库中的std::panic::catch_unwind()函数。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=n>catch_unwind</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=n>block_on</span><span class=p>(</span><span class=no>GLOBAL</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=n>future</span>::<span class=n>pending</span>::<span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=p>()))).</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;cannot spawn executor thread&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Executor</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>GLOBAL</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=n>future</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=聊天框例子>聊天框例子</h3><h4 id=chat-server>chat-server</h4><p>聊天框服务器的事件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// An event on the chat server.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>enum</span> <span class=nc>Event</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// A client has joined.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>Join</span><span class=p>(</span><span class=n>SocketAddr</span><span class=p>,</span><span class=w> </span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Async</span><span class=o>&lt;</span><span class=n>TcpStream</span><span class=o>&gt;&gt;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// A client has left.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>Leave</span><span class=p>(</span><span class=n>SocketAddr</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// A client sent a message.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>Message</span><span class=p>(</span><span class=n>SocketAddr</span><span class=p>,</span><span class=w> </span><span class=nb>String</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>向客户端分发事件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// Dispatches events to clients.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>dispatch</span><span class=p>(</span><span class=n>receiver</span>: <span class=nc>Receiver</span><span class=o>&lt;</span><span class=n>Event</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Currently active clients.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HashMap</span>::<span class=o>&lt;</span><span class=n>SocketAddr</span><span class=p>,</span><span class=w> </span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Async</span><span class=o>&lt;</span><span class=n>TcpStream</span><span class=o>&gt;&gt;&gt;</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Receive incoming events.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>receiver</span><span class=p>.</span><span class=n>recv</span><span class=p>().</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Process the event and format a message to send to clients.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Event</span>::<span class=n>Join</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>stream</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>map</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>stream</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s> has joined</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Event</span>::<span class=n>Leave</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>map</span><span class=p>.</span><span class=n>remove</span><span class=p>(</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s> has left</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Event</span>::<span class=n>Message</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s> says: </span><span class=si>{}</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Display the event in the server process.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>output</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Send the event to all active clients.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>stream</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=n>values_mut</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Ignore errors because the client might disconnect at any point.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>stream</span><span class=p>.</span><span class=n>write_all</span><span class=p>(</span><span class=n>output</span><span class=p>.</span><span class=n>as_bytes</span><span class=p>()).</span><span class=k>await</span><span class=p>.</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>服务端 main 函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>smol</span>::<span class=n>block_on</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Create a listener for incoming client connections.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>listener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Async</span>::<span class=o>&lt;</span><span class=n>TcpListener</span><span class=o>&gt;</span>::<span class=n>bind</span><span class=p>(([</span><span class=mi>127</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=mi>6000</span><span class=p>))</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Intro messages.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Listening on </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>listener</span><span class=p>.</span><span class=n>get_ref</span><span class=p>().</span><span class=n>local_addr</span><span class=p>()</span><span class=o>?</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Start a chat client now!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Spawn a background task that dispatches events to clients.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>// 通过 channel 实现消息传递
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>sender</span><span class=p>,</span><span class=w> </span><span class=n>receiver</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bounded</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// detach 函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>// 分离任务，让它在后台运行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>smol</span>::<span class=n>spawn</span><span class=p>(</span><span class=n>dispatch</span><span class=p>(</span><span class=n>receiver</span><span class=p>)).</span><span class=n>detach</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Accept the next connection.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>stream</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>listener</span><span class=p>.</span><span class=n>accept</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arc</span>::<span class=n>new</span><span class=p>(</span><span class=n>stream</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>sender</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sender</span><span class=p>.</span><span class=n>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Spawn a background task reading messages from the client.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>smol</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=k>move</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Client starts with a `Join` event.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=n>sender</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>Event</span>::<span class=n>Join</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=n>clone</span><span class=p>())).</span><span class=k>await</span><span class=p>.</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Read messages from the client and ignore I/O errors when the client quits.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=n>read_messages</span><span class=p>(</span><span class=n>sender</span><span class=p>.</span><span class=n>clone</span><span class=p>(),</span><span class=w> </span><span class=n>client</span><span class=p>).</span><span class=k>await</span><span class=p>.</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Client ends with a `Leave` event.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=n>sender</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>Event</span>::<span class=n>Leave</span><span class=p>(</span><span class=n>addr</span><span class=p>)).</span><span class=k>await</span><span class=p>.</span><span class=n>ok</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>detach</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=chat-client>chat-client</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>smol</span>::<span class=n>block_on</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Connect to the server and create async stdin and stdout.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Async</span>::<span class=o>&lt;</span><span class=n>TcpStream</span><span class=o>&gt;</span>::<span class=n>connect</span><span class=p>(([</span><span class=mi>127</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=mi>6000</span><span class=p>)).</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>stdin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unblock</span>::<span class=n>new</span><span class=p>(</span><span class=n>std</span>::<span class=n>io</span>::<span class=n>stdin</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>stdout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unblock</span>::<span class=n>new</span><span class=p>(</span><span class=n>std</span>::<span class=n>io</span>::<span class=n>stdout</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Intro messages.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Connected to </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>get_ref</span><span class=p>().</span><span class=n>peer_addr</span><span class=p>()</span><span class=o>?</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;My nickname: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>get_ref</span><span class=p>().</span><span class=n>local_addr</span><span class=p>()</span><span class=o>?</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Type a message and hit enter!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>stream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>writer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>stream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Wait until the standard input is closed or the connection is closed.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>future</span>::<span class=n>race</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>io</span>::<span class=n>copy</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>writer</span><span class=p>).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Quit!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>res</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>io</span>::<span class=n>copy</span><span class=p>(</span><span class=n>reader</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>stdout</span><span class=p>).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Server disconnected!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>res</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=futures_lite>futures_lite</h3><p>文档：<a class=link href=https://docs.rs/futures-lite/latest/futures_lite/ target=_blank rel=noopener>futures_lite</a>，futures库的轻量版。</p><p><a class=link href=https://docs.rs/futures-lite/latest/futures_lite/#modules target=_blank rel=noopener>Modules</a></p><div class=table-wrapper><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><a class=link href=https://docs.rs/futures-lite/latest/futures_lite/future/index.html target=_blank rel=noopener>future</a></td><td>Combinators for the <a class=link href=https://doc.rust-lang.org/nightly/core/future/future/trait.Future.html target=_blank rel=noopener><code>Future</code></a> trait.</td></tr><tr><td><a class=link href=https://docs.rs/futures-lite/latest/futures_lite/io/index.html target=_blank rel=noopener>io</a></td><td>Tools and combinators for I/O.</td></tr><tr><td><a class=link href=https://docs.rs/futures-lite/latest/futures_lite/prelude/index.html target=_blank rel=noopener>prelude</a></td><td>Traits <a class=link href=https://doc.rust-lang.org/nightly/core/future/future/trait.Future.html target=_blank rel=noopener><code>Future</code></a>, <a class=link href=https://docs.rs/futures-core/0.3.15/futures_core/stream/trait.Stream.html target=_blank rel=noopener><code>Stream</code></a>, <a class=link href=https://docs.rs/futures-io/0.3.15/futures_io/if_std/trait.AsyncRead.html target=_blank rel=noopener><code>AsyncRead</code></a>, <a class=link href=https://docs.rs/futures-io/0.3.15/futures_io/if_std/trait.AsyncWrite.html target=_blank rel=noopener><code>AsyncWrite</code></a>, <a class=link href=https://docs.rs/futures-io/0.3.15/futures_io/if_std/trait.AsyncBufRead.html target=_blank rel=noopener><code>AsyncBufRead</code></a>, <a class=link href=https://docs.rs/futures-io/0.3.15/futures_io/if_std/trait.AsyncSeek.html target=_blank rel=noopener><code>AsyncSeek</code></a>, and their extensions.</td></tr><tr><td><a class=link href=https://docs.rs/futures-lite/latest/futures_lite/stream/index.html target=_blank rel=noopener>stream</a></td><td>Combinators for the <a class=link href=https://docs.rs/futures-core/0.3.15/futures_core/stream/trait.Stream.html target=_blank rel=noopener><code>Stream</code></a> trait.</td></tr></tbody></table></div><p>主要就是上述四个模块。</p><h3 id=async_io>async_io</h3><p>文档：<a class=link href=https://docs.rs/async-io/latest/async_io/ target=_blank rel=noopener>async_io</a></p><p>在async_io/lib.rs中定义了两个结构体，一个是Timer，另一个是Async。</p><ul><li>Timer: 在某个时间点到期的 Future。</li><li>Async: 在异步编程中在标准网络类型（还有许多其他类型的）中使用的一个适配器。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Timer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// This timer&#39;s ID and last waker that polled it.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// When this field is set to `None`, this timer is not registered in the reactor.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>id_and_waker</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=p>(</span><span class=kt>usize</span><span class=p>,</span><span class=w> </span><span class=n>Waker</span><span class=p>)</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// The next instant at which this timer fires.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>when</span>: <span class=nc>Instant</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// The period.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>period</span>: <span class=nc>Duration</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Async</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// A source registered in the reactor.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>source</span>: <span class=nc>Arc</span><span class=o>&lt;</span><span class=n>Source</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// The inner I/O handle.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>io</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里用到了<a class=link href=https://docs.rs/polling/latest/polling/ target=_blank rel=noopener>polling</a> crate。这个库实现了跨平台的poll，提供了很多接口。</p><blockquote><p>Portable interface to epoll, kqueue, event ports, and wepoll.
Supported platforms:</p><ul><li>epoll : Linux, Android</li><li>kqueue : macOS, iOS, FreeBSD, NetBSD, OpenBSD, DragonFly BSD</li><li>event ports : illumos, Solaris</li><li>poll : VxWorks, Fuchsia, other Unix systems</li><li>wepoll : Windows</li></ul></blockquote><p>下面看看 async_io/reactor.rs</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>struct</span> <span class=nc>Reactor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Portable bindings to epoll/kqueue/event ports/wepoll.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// This is where I/O is polled, producing I/O events.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>poller</span>: <span class=nc>Poller</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Ticker bumped before polling.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// This is useful for checking what is the current &#34;round&#34; of `ReactorLock::react()` when
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// synchronizing things in `Source::readable()` and `Source::writable()`. Both of those
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// methods must make sure they don&#39;t receive stale I/O events - they only accept events from a
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// fresh &#34;round&#34; of `ReactorLock::react()`.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>ticker</span>: <span class=nc>AtomicUsize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Registered sources.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>sources</span>: <span class=nc>Mutex</span><span class=o>&lt;</span><span class=n>Slab</span><span class=o>&lt;</span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Source</span><span class=o>&gt;&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Temporary storage for I/O events when polling the reactor.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// Holding a lock on this event list implies the exclusive right to poll I/O.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>events</span>: <span class=nc>Mutex</span><span class=o>&lt;</span><span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Event</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// An ordered map of registered timers.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// Timers are in the order in which they fire. The `usize` in this type is a timer ID used to
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// distinguish timers that fire at the same time. The `Waker` represents the task awaiting the
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// timer.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>timers</span>: <span class=nc>Mutex</span><span class=o>&lt;</span><span class=n>BTreeMap</span><span class=o>&lt;</span><span class=p>(</span><span class=n>Instant</span><span class=p>,</span><span class=w> </span><span class=kt>usize</span><span class=p>),</span><span class=w> </span><span class=n>Waker</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// A queue of timer operations (insert and remove).
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// When inserting or removing a timer, we don&#39;t process it immediately - we just push it into
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// this queue. Timers actually get processed when the queue fills up or the reactor is polled.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>timer_ops</span>: <span class=nc>ConcurrentQueue</span><span class=o>&lt;</span><span class=n>TimerOp</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>还有 async_io/driver.rs，其中有main_loop函数，对async_io线程进行主要的循环，另外还有block_on函数，在有异步任务时阻塞当前的线程，在空闲的时候处理IO事件。</p><h3 id=async_task>async_task</h3><p>文档： <a class=link href=https://docs.rs/async-task/latest/async_task/ target=_blank rel=noopener>async_task</a></p><p>Task abstraction for building executors.</p><p>To spawn a future onto an executor, we first need to allocate it on the heap and keep some state attached to it. The state indicates whether the future is ready for polling, waiting to be woken up, or completed. Such a stateful future is called a task.</p><p>All executors have a queue that holds scheduled tasks:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>sender</span><span class=p>,</span><span class=w> </span><span class=n>receiver</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>flume</span>::<span class=n>unbounded</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里用到了第三方库<a class=link href=https://docs.rs/flume/0.10.14/flume/ target=_blank rel=noopener>flume</a>。它比 crossbeam-channel 更加轻量，实现了mpmc。</p><p>接着来看 async_task 的函数：</p><ul><li>spawn 创建一个新任务。</li><li>spawn_local 创建一个新的本地任务。</li><li>spawn_unchecked⚠ Creates a new task without Send, Sync, and &lsquo;static bounds.</li></ul><p>async_task 的结构：</p><ul><li>FallibleTask: A spawned task with a fallible response.</li><li>Runnable: A handle to a runnable task.</li><li>Task: A spawned task.</li></ul><p>在 async_task/raw.rs 中定义了底层的TaskVTable、TaskLayout、RawTask。</p><p>在 async_task/header.rs 中定义了结构体Header。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>struct</span> <span class=nc>Header</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Current state of the task.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// Contains flags representing the current state and the reference count.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>state</span>: <span class=nc>AtomicUsize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// The task that is blocked on the `Task` handle.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// This waker needs to be woken up once the task completes or is closed.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>awaiter</span>: <span class=nc>UnsafeCell</span><span class=o>&lt;</span><span class=nb>Option</span><span class=o>&lt;</span><span class=n>Waker</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// The virtual table.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// In addition to the actual waker virtual table, it also contains pointers to several other
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// methods necessary for bookkeeping the heap-allocated task.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>vtable</span>: <span class=kp>&amp;</span><span class=nb>&#39;static</span> <span class=nc>TaskVTable</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相当于做一些任务的处理，提供了notify、take、register三个函数。</p><p>这里面任务的状态state是在state.rs中定义的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// Set if the task is scheduled for running.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>SCHEDULED</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Set if the task is running.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>RUNNING</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Set if the task has been completed.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>COMPLETED</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Set if the task is closed.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>CLOSED</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Set if the `Task` still exists.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>TASK</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Set if the `Task` is awaiting the output.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>AWAITER</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Set if an awaiter is being registered.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>REGISTERING</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Set if the awaiter is being notified.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>NOTIFYING</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>7</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// A single reference.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>REFERENCE</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=async_executor>async_executor</h3><p>异步执行器。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>async_executor</span>::<span class=n>Executor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>futures_lite</span>::<span class=n>future</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Create a new executor.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span><span class=w> </span><span class=n>ex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executor</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Spawn a task.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span><span class=w> </span><span class=n>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello world&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Run the executor until the task completes.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>future</span>::<span class=n>block_on</span><span class=p>(</span><span class=n>ex</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=n>task</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=blocking>blocking</h3><p>文档：<a class=link href=https://docs.rs/blocking/latest/blocking/ target=_blank rel=noopener>blocking</a></p><p>在异步程序里提供了一个线程池用于隔离阻塞的IO。</p><p>unblock 函数：对阻塞的代码进行异步化。</p><p>Unblock 类型：对阻塞的IO进行异步化。通过维护一个环形队列来进行处理。</p><p><a class=link href=https://docs.rs/async-fs/latest/async_fs/ target=_blank rel=noopener>async-fs</a> 其中用到了 blocking 这个库。</p><h2 id=async-std>async-std</h2><p>文档：<a class=link href=https://docs.rs/async-std/1.12.0/async_std/ target=_blank rel=noopener>async_std</a>，rust标准库的异步版本。</p><p>task的使用以及抽象出来的API接口类似线程，易于上手。</p><p>async_std 和 smol 运行时一些架构以及组件都是公用的，并且它提供了一个类似于线程的一个异步 task 的抽象，并且它还兼容 tokio。</p><h2 id=tokio>tokio</h2><p>github仓库地址：<a class=link href=https://github.com/tokio-rs/tokio target=_blank rel=noopener>tokio</a></p><p>官方网站：<a class=link href=https://tokio.rs/ target=_blank rel=noopener>tokio.rs</a></p><p>文档：<a class=link href=https://docs.rs/tokio/latest/tokio/ target=_blank rel=noopener>tokio</a></p><p>官方文档介绍：</p><p>A runtime for writing reliable network applications without compromising speed.</p><p>Tokio is an event-driven, non-blocking I/O platform for writing asynchronous applications with the Rust programming language. At a high level, it provides a few major components:</p><ul><li>Tools for working with asynchronous tasks, including synchronization primitives and channels and timeouts, sleeps, and intervals.</li><li>APIs for performing asynchronous I/O, including TCP and UDP sockets, filesystem operations, and process and signal management.</li><li>A runtime for executing asynchronous code, including a task scheduler, an I/O driver backed by the operating system’s event queue (epoll, kqueue, IOCP, etc…), and a high performance timer.</li></ul><p>Remark: loom 模块用来检测异步并发，也可以检测同步并发。</p><h3 id=mini-redis>mini-redis</h3><ul><li>github仓库地址：<a class=link href=https://github.com/tokio-rs/mini-redis target=_blank rel=noopener>mini-redis</a></li></ul><p><a class=link href=https://www.runoob.com/redis/redis-tutorial.html target=_blank rel=noopener>Redis教程</a></p><p><code>#[tokio::main]</code>宏，定义在tokio-macros/lib.rs中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello world&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>宏展开之后为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tokio</span>::<span class=n>runtime</span>::<span class=n>Builder</span>::<span class=n>new_multi_thread</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>enable_all</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>block_on</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello world&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[proc_macro_attribute]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[cfg(not(test))]</span><span class=w> </span><span class=c1>// Work around for rust-lang/rust#62127
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>(</span><span class=n>args</span>: <span class=nc>TokenStream</span><span class=p>,</span><span class=w> </span><span class=n>item</span>: <span class=nc>TokenStream</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>TokenStream</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>entry</span>::<span class=n>main</span><span class=p>(</span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=n>item</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在entry.rs中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[cfg(not(test))]</span><span class=w> </span><span class=c1>// Work around for rust-lang/rust#62127
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>(</span><span class=n>args</span>: <span class=nc>TokenStream</span><span class=p>,</span><span class=w> </span><span class=n>item</span>: <span class=nc>TokenStream</span><span class=p>,</span><span class=w> </span><span class=n>rt_multi_thread</span>: <span class=kt>bool</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>TokenStream</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// If any of the steps for this macro fail, we still want to expand to an item that is as close
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// to the expected output as possible. This helps out IDEs such that completions and other
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// related features keep working.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>input</span>: <span class=nc>syn</span>::<span class=n>ItemFn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>syn</span>::<span class=n>parse</span><span class=p>(</span><span class=n>item</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>it</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>it</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>token_stream_with_error</span><span class=p>(</span><span class=n>item</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=n>sig</span><span class=p>.</span><span class=n>ident</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;main&#34;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>input</span><span class=p>.</span><span class=n>sig</span><span class=p>.</span><span class=n>inputs</span><span class=p>.</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;the main function cannot accept arguments&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>syn</span>::<span class=n>Error</span>::<span class=n>new_spanned</span><span class=p>(</span><span class=o>&amp;</span><span class=n>input</span><span class=p>.</span><span class=n>sig</span><span class=p>.</span><span class=n>ident</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AttributeArgs</span>::<span class=n>parse_terminated</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>parse</span><span class=p>(</span><span class=n>args</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>and_then</span><span class=p>(</span><span class=o>|</span><span class=n>args</span><span class=o>|</span><span class=w> </span><span class=n>build_config</span><span class=p>(</span><span class=n>input</span><span class=p>.</span><span class=n>clone</span><span class=p>(),</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>rt_multi_thread</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>config</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>parse_knobs</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>token_stream_with_error</span><span class=p>(</span><span class=n>parse_knobs</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=no>DEFAULT_ERROR_CONFIG</span><span class=p>),</span><span class=w> </span><span class=n>e</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>还有一个select宏，官方教程参见<a class=link href=https://tokio.rs/tokio/tutorial/select target=_blank rel=noopener>Select</a>。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>tokio</span>::<span class=n>sync</span>::<span class=n>oneshot</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>tx1</span><span class=p>,</span><span class=w> </span><span class=n>rx1</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oneshot</span>::<span class=n>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>tx2</span><span class=p>,</span><span class=w> </span><span class=n>rx2</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oneshot</span>::<span class=n>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tokio</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tx1</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=s>&#34;one&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tokio</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tx2</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=s>&#34;two&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tokio</span>::<span class=fm>select!</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rx1</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;rx1 completed first with </span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>val</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rx2</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;rx2 completed first with </span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>val</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>tokio的运行时是通过Builder来创建的。tokio中分两种线程，core线程专门处理异步，blocking线程处理同步。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Builder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Runtime type
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>kind</span>: <span class=nc>Kind</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Whether or not to enable the I/O driver
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>enable_io</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Whether or not to enable the time driver
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>enable_time</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Whether or not the clock should start paused.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>start_paused</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// The number of worker threads, used by Runtime.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// Only used when not using the current-thread executor.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>worker_threads</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=kt>usize</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=c1>// core 线程
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Cap on thread usage.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>max_blocking_threads</span>: <span class=kt>usize</span><span class=p>,</span><span class=w> </span><span class=c1>// blocking线程最大数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Name fn used for threads spawned by the runtime.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>thread_name</span>: <span class=nc>ThreadNameFn</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Stack size used for threads spawned by the runtime.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>thread_stack_size</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=kt>usize</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Callback to run after each thread starts.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>after_start</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Callback</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// To run before each worker thread stops
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>before_stop</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Callback</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// To run before each worker thread is parked.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>before_park</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Callback</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// To run after each thread is unparked.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>after_unpark</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Callback</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Customizable keep alive timeout for BlockingPool
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>keep_alive</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Duration</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// How many ticks before pulling a task from the global/remote queue?
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>global_queue_interval</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// How many ticks before yielding to the driver for timer and I/O events?
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>event_interval</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[cfg(tokio_unstable)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=n>unhandled_panic</span>: <span class=nc>UnhandledPanic</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>tokio/park：</p><p>有事件唤醒线程让它去spawn task，如果没有的话就等待 park。</p><p>tokio中的任务队列tokio/src/runtime/thread_pool/worker.rs。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// A scheduler worker
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=p>(</span><span class=k>super</span><span class=p>)</span><span class=w> </span><span class=k>struct</span> <span class=nc>Worker</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Reference to shared state
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>shared</span>: <span class=nc>Arc</span><span class=o>&lt;</span><span class=n>Shared</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Index holding this worker&#39;s remote state
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>index</span>: <span class=kt>usize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Used to hand-off a worker&#39;s core to another thread.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>core</span>: <span class=nc>AtomicCell</span><span class=o>&lt;</span><span class=n>Core</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Core data
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>struct</span> <span class=nc>Core</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Used to schedule bookkeeping tasks every so often.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>tick</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// When a task is scheduled from a worker, it is stored in this slot. The
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// worker will check this slot for a task **before** checking the run
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// queue. This effectively results in the **last** scheduled task to be run
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// next (LIFO). This is an optimization for message passing patterns and
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// helps to reduce latency.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>lifo_slot</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Notified</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=c1>// 后进先出队列，做了优化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// The worker-local run queue.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>run_queue</span>: <span class=nc>queue</span>::<span class=n>Local</span><span class=o>&lt;</span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Shared</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w> </span><span class=c1>// 本地队列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// True if the worker is currently searching for more work. Searching
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// involves attempting to steal from other workers.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>is_searching</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// True if the scheduler is being shutdown
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>is_shutdown</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Parker
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// Stored in an `Option` as the parker is added / removed to make the
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=sd>/// borrow checker happy.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>park</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Parker</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Batching metrics so they can be submitted to RuntimeMetrics.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>metrics</span>: <span class=nc>MetricsBatch</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Fast random number generator.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>rand</span>: <span class=nc>FastRand</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// How many ticks before pulling a task from the global/remote queue?
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>global_queue_interval</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// How many ticks before yielding to the driver for timer and I/O events?
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=n>event_interval</span>: <span class=kt>u32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>提供了一个方法block_in_place，可以将当前线程变为阻塞线程。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>block_in_place</span><span class=o>&lt;</span><span class=n>F</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=p>(</span><span class=n>f</span>: <span class=nc>F</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>R</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>F</span>: <span class=nb>FnOnce</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>R</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=流处理>流处理</h3><p>文档参考：<a class=link href=https://docs.rs/tokio-util/0.7.3/tokio_util/codec/index.html target=_blank rel=noopener>tokio_util::codec</a>。</p><p>Adaptors from AsyncRead/AsyncWrite to Stream/Sink</p><p>Raw I/O objects work with byte sequences, but higher-level code usually wants to batch these into meaningful chunks, called “frames”.</p><p>This module contains adapters to go from streams of bytes, AsyncRead and AsyncWrite, to framed streams implementing Sink and Stream. Framed streams are also known as transports.</p><p>tokio-stream抽象了一种帧结果，也提供相应的适配器进行异步读写。如果想更好的进行异步读写，可以使用抽象的codec，也可以使用更底层的Sink/Stream进行处理。</p><p><a class=link href=https://github.com/hyperium/tonic target=_blank rel=noopener>tonic</a>：实现gRPC客户端和服务端，自己实现Stream，从而来进行异步读写。</p><p><a class=link href=https://github.com/seanmonstar/warp target=_blank rel=noopener>wrap</a>：实现文件上传，也是通过自己实现Stream。</p><p><a class=link href=https://github.com/redis-rs/redis-rs target=_blank rel=noopener>redis-rs</a>：redis library。这里用到了解析器组合子<a class=link href=https://github.com/Marwes/combine target=_blank rel=noopener>combine</a>。</p><h3 id=扩展资料>扩展资料</h3><ul><li><a class=link href=https://tony612.github.io/tokio-internals/ target=_blank rel=noopener>Tokio Internals - 源码解析和设计分析</a></li></ul><h2 id=参考资料>参考资料</h2><p><a class=link href=https://time.geekbang.org/course/intro/348 target=_blank rel=noopener>张汉东的Rust实战课</a></p><p><a class=link href=https://github.com/ZhangHanDong/inviting-rust target=_blank rel=noopener>张汉东的Rust实战课视频课程代码示例</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/rust/>Rust</a>
<a href=/tags/%E5%BC%82%E6%AD%A5/>异步</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title></h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2022/08/23/rust-web/><div class=article-details><h2 class=article-title>Rust异步Web框架</h2></div></a></article><article><a href=/2022/07/31/RustChinaConf/><div class=article-details><h2 class=article-title>Rust开发者大会</h2></div></a></article><article><a href=/2022/07/05/Programming-Rust/><div class=article-details><h2 class=article-title>Programming Rust</h2></div></a></article><article><a href=/2022/07/05/Rust-meta-programming/><div class=article-details><h2 class=article-title>Rust元编程</h2></div></a></article><article class=has-image><a href=/2022/11/19/hugo-post/><div class=article-image><img src=/img/2022-11-19-hugo-post/background.jpg loading=lazy data-key data-hash=/img/2022-11-19-hugo-post/background.jpg></div><div class=article-details><h2 class=article-title>如何用Hugo + Github Action部署个人博客</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Jade's Blog</section><section class=powerby><br></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>